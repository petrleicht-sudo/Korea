<!DOCTYPE html>
<html lang="cs" class="scroll-smooth">
<head>
    <!-- Google Maps API key will be injected by backend as window.__GOOGLE_MAPS_API_KEY__ -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interaktivn√≠ Pr≈Øvodce: Podzimn√≠ Dobrodru≈æstv√≠ v Ji≈æn√≠ Koreji a Abu Dhabi 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- Google Maps API - ZDE VLO≈ΩTE SV≈ÆJ GOOGLE MAPS API KL√çƒå -->
    <!-- Pro spr√°vnou funkci map je nutn√© nahradit 'YOUR_GOOGLE_MAPS_API_KEY' va≈°√≠m platn√Ωm API kl√≠ƒçem. -->
    

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; color: #1f2937; }
        .kpi-card { background-color: white; border-radius: 0.75rem; padding: 1.5rem; text-align: center; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .timeline-item { position: relative; padding-bottom: 2.5rem; padding-left: 2.5rem; }
        .timeline-item:not(:last-child)::before { content: ''; position: absolute; left: 0.5rem; top: 0.75rem; width: 2px; height: 100%; background-color: #8DD7BF; }
        .timeline-dot { position: absolute; left: 0; top: 0.5rem; height: 1.25rem; width: 1.25rem; border-radius: 9999px; background-color: #00A5E3; border: 3px solid white; }
        .chart-container { position: relative; width: 100%; max-width: 500px; margin-left: auto; margin-right: auto; height: 300px; max-height: 350px; }
        @media (min-width: 768px) { .chart-container { height: 350px; max-height: 400px; } }
        .tab-button.active { background-color: #00A5E3; color: white; border-color: #00A5E3; }
        .details-content { max-height: 0; overflow: hidden; transition: max-height 0.7s cubic-bezier(0.4, 0, 0.2, 1); }
        .map-container { height: 300px; width: 100%; background-color: #e0e0e0; } /* Z√°kladn√≠ styl pro mapu */
        /* Oprava pro sticky navigaci: Zajist√≠, aby se obsah posunul pod navigaƒçn√≠ li≈°tu */
        section[id] {
            scroll-margin-top: 4rem; /* Upravte podle v√Ω≈°ky va≈°√≠ sticky hlaviƒçky */
        }
        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #00A5E3;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Lightbox styles */
        .lightbox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .lightbox-content {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }
        .lightbox-caption {
            color: white;
            margin-top: 10px;
            font-size: 1.2rem;
            text-align: center;
        }
        .close-lightbox {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 30px;
            cursor: pointer;
        }
        /* Custom Confirm Modal */
        #custom-confirm-modal {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body class="antialiased">

    <!-- Login Modal - Zobraz√≠ se automaticky p≈ôi naƒçten√≠ str√°nky, dokud se u≈æivatel nep≈ôihl√°s√≠ -->
    <div id="login-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm text-center">
            <h2 class="text-2xl font-bold mb-4" style="color: #002D62;">P≈ôihlaste se</h2>
            <form id="login-form-content">
                <input type="email" id="email-input" placeholder="E-mail" class="w-full p-2 mb-2 border rounded" required>
                <input type="password" id="password-input" placeholder="Heslo" class="w-full p-2 mb-2 border rounded" required>
                <button type="submit" id="submit-login-btn" class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg w-full mb-2">P≈ôihl√°sit se</button>
                <!-- Tlaƒç√≠tko pro registraci bylo odstranƒõno -->
                <p id="login-error" class="text-red-500 text-sm mt-2"></p>
            </form>
            <div class="mt-4 border-t pt-4">
                <button id="anonymous-login-btn-modal" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg w-full">Pokraƒçovat anonymnƒõ</button>
            </div>
        </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="custom-confirm-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm text-center">
            <p id="confirm-message" class="text-lg mb-4">Are you sure?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-yes" class="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg">Ano</button>
                <button id="confirm-no" class="bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded-lg">Ne</button>
            </div>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="custom-alert-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm text-center">
            <p id="alert-message" class="text-lg mb-4">Alert message.</p>
            <button id="alert-ok" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg">OK</button>
        </div>
    </div>

    <!-- Hlavn√≠ obsah str√°nky - Zpoƒç√°tku skryt√Ω -->
    <div id="main-content" class="container mx-auto p-4 md:p-8 hidden">

        <header class="text-center mb-12">
            <h1 class="text-4xl md:text-6xl font-black mb-2" style="color: #002D62;">Podzimn√≠ Dobrodru≈æstv√≠ v Ji≈æn√≠ Koreji a Abu Dhabi</h1>
            <p class="text-lg md:text-xl text-gray-600">V√°≈° interaktivn√≠ pr≈Øvodce na m√≠ru (6. ‚Äì 21. ≈ô√≠jna 2025)</p>
            <div class="flex justify-center items-center mt-4 space-x-4">
                <p id="user-id-display" class="text-sm text-gray-500">Naƒç√≠t√°n√≠ u≈æivatele...</p>
                <!-- Tlaƒç√≠tko pro zobrazen√≠ p≈ôihla≈°ovac√≠ho formul√°≈ôe (zobraz√≠ se po odhl√°≈°en√≠ nebo pro anonymn√≠ u≈æivatele) -->
                <button id="show-login-form-btn" class="bg-blue-500 hover:bg-blue-600 text-white text-sm py-1 px-3 rounded-full hidden">P≈ôihl√°sit se</button>
                <!-- Tlaƒç√≠tko pro odhl√°≈°en√≠ (zobraz√≠ se pro u≈æivatele p≈ôihl√°≈°en√© e-mailem) -->
                <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white text-sm py-1 px-3 rounded-full hidden">Odhl√°sit se</button>
            </div>
        </header>

        <nav class="sticky top-0 bg-white/80 backdrop-blur-sm z-10 py-3 mb-12 rounded-lg shadow-md">
            <ul class="flex justify-center space-x-4 md:space-x-8">
                <li><a href="#overview" class="font-bold text-gray-600 hover:text-blue-600 transition">P≈ôehled</a></li>
                <li><a href="#planning" class="font-bold text-gray-600 hover:text-blue-600 transition">P≈ô√≠prava</a></li>
                <li><a href="#itinerary" class="font-bold text-gray-600 hover:text-blue-600 transition">Itiner√°≈ô</a></li>
                <li><a href="#budget" class="font-bold text-gray-600 hover:text-blue-600 transition">Celkov√Ω Rozpoƒçet</a></li>
            </ul>
        </nav>

        <section id="overview" class="mb-16">
            <h2 class="text-3xl font-bold text-center mb-8" style="color: #002D62;">Cesta v Kostce</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
                <div class="kpi-card"><div class="text-5xl mb-2">üóìÔ∏è</div><h3 class="text-xl font-bold">16 Dn√≠</h3><p class="text-gray-500">Kultury, p≈ô√≠rody a K-Popu</p></div>
                <div class="kpi-card"><div class="text-5xl mb-2">üèôÔ∏è</div><h3 class="text-xl font-bold">5 Destinac√≠</h3><p class="text-gray-500">Abu Dhabi, Soul, Pusan, Gyeongju, ƒåed≈æu</p></div>
                <div class="kpi-card"><div class="text-5xl mb-2">üë®‚Äçüë©‚Äçüëß</div><h3 class="text-xl font-bold">3 Cestovatel√©</h3><p class="text-gray-500">Rodinn√Ω z√°≈æitek na m√≠ru</p></div>
                <div class="kpi-card"><div class="text-5xl mb-2">üí∞</div><h3 class="text-xl font-bold">&lt; 45 000 Kƒç</h3><p class="text-gray-500">Rozpoƒçet na osobu</p></div>
            </div>
             <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg">
                <p class="text-center text-gray-600 max-w-3xl mx-auto">V√≠tejte ve va≈°em osobn√≠m interaktivn√≠m pr≈Øvodci pro nezapomenuteln√© cestu do Ji≈æn√≠ Koreje a Abu Dhabi! Tato aplikace je navr≈æena tak, aby v√°m poskytla v≈°echny pot≈ôebn√© informace v p≈ôehledn√© a vizu√°lnƒõ poutav√© formƒõ. Od hlavn√≠ch statistik va≈°√≠ cesty p≈ôes praktick√© tipy a≈æ po detailn√≠ denn√≠ itiner√°≈ô a anal√Ωzu rozpoƒçtu ‚Äì v≈°e m√°te na jednom m√≠stƒõ. Prozkoumejte pl√°n, rozkliknƒõte si detaily a p≈ôipravte se na dobrodru≈æstv√≠ pln√© kultury, historie a modern√≠ch z√°≈æitk≈Ø, kter√© ƒçek√° jen na v√°s.</p>
             </div>
        </section>

        <section id="planning" class="mb-16">
            <h2 class="text-3xl font-bold text-center mb-8" style="color: #002D62;">Ne≈æ Vyraz√≠te: Kl√≠ƒçov√© Informace</h2>
            <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg">
                <div class="mb-4 border-b border-gray-200">
                    <div class="flex flex-wrap -mb-px" id="info-tabs">
                        <button class="tab-button active mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" data-tab="visa">Vstup & V√≠za</button>
                        <button class="tab-button mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" data-tab="money">Mƒõna & Platby</button>
                        <button class="tab-button mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" data-tab="weather">Poƒças√≠ & Balen√≠</button>
                        <button class="tab-button mr-2 inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" data-tab="etiquette">Etiketa</button>
                        <button class="tab-button inline-block p-4 border-b-2 border-transparent rounded-t-lg hover:text-gray-600 hover:border-gray-300" data-tab="holidays">Sv√°tky</button>
                    </div>
                </div>
                <div id="tab-content">
                    <div class="tab-pane active p-4" id="visa-content">
                        <h3 class="text-xl font-bold mb-2">Vstupn√≠ Po≈æadavky</h3>
                        <p class="mb-2">Pro obƒçany ƒåR plat√≠ do 31. 12. 2025 v√Ωjimka z povinnosti m√≠t K-ETA pro Ji≈æn√≠ Koreu, co≈æ ≈°et≈ô√≠ ƒças i poplatek 10 000 KRW.</p>
                        <p class="mb-2"><strong>Novinka pro Koreu:</strong> Od 24. 2. 2025 je povinn√© vyplnit online elektronickou p≈ô√≠jezdovou kartu (e-Arrival Card) nejpozdƒõji 3 dny p≈ôed p≈ô√≠letem. Je zdarma a plat√≠ 72 hodin.</p>
                        <p class="mb-2"><strong>Pro Spojen√© arabsk√© emir√°ty (Abu Dhabi):</strong> Obƒçan√© ƒåR nepot≈ôebuj√≠ v√≠zum pro turistick√© pobyty do 90 dn≈Ø.</p>
                        <p>Platnost pasu mus√≠ b√Ωt minim√°lnƒõ 6 mƒõs√≠c≈Ø po pl√°novan√©m n√°vratu. Pas je nutn√© m√≠t s sebou na prohl√≠dku DMZ.</p>
                    </div>
                    <div class="tab-pane hidden p-4" id="money-content">
                        <h3 class="text-xl font-bold mb-2">Mƒõna a Platby</h3>
                        <p class="mb-2">M√≠stn√≠ mƒõnou v Koreji je korejsk√Ω won (KRW). V Abu Dhabi je to emir√°tsk√Ω dirham (AED).</p>
                        <p class="mb-2">Pro rozpoƒçet je pou≈æit kurz 1 CZK = 50,67 KRW a 1 AED = 6,2 CZK.</p>
                        <p class="mb-2">Kreditn√≠ karty jsou ≈°iroce p≈ôij√≠m√°ny, ale hotovost je nutn√° na trz√≠ch a v men≈°√≠ch podnic√≠ch.</p>
                        <p class="mb-2"><strong>Spropitn√© nen√≠ zvykem v Koreji</strong> a m≈Ø≈æe b√Ωt pova≈æov√°no za ur√°≈æliv√©. V Abu Dhabi je spropitn√© oƒçek√°v√°no v restaurac√≠ch a pro slu≈æby.</p>
                        <p><strong>Karta T-Money (Korea)</strong> je nezbytn√° pro m√≠stn√≠ dopravu. ≈†et≈ô√≠ 100 KRW na ka≈æd√© j√≠zdƒõ a umo≈æ≈àuje slevy na p≈ôestupy.</p>
                    </div>
                    <div class="tab-pane hidden p-4" id="weather-content">
                        <h3 class="text-xl font-bold mb-2">≈ò√≠jnov√© Poƒças√≠ a Balen√≠</h3>
                        <p class="mb-2"><strong>Korea:</strong> ≈ò√≠jen nab√≠z√≠ ide√°ln√≠ poƒças√≠: v Soulu pr≈Ømƒõrnƒõ 9-20¬∞C, sluneƒçno a m√°lo sr√°≈æek. Perfektn√≠ ƒças pro pozorov√°n√≠ podzimn√≠ho list√≠.</p>
                        <p class="mb-2"><strong>Abu Dhabi:</strong> V ≈ô√≠jnu se teploty pohybuj√≠ kolem 25-35¬∞C, je sluneƒçno a sucho. Oƒçek√°vejte hork√© dny a tepl√© veƒçery.</p>
                        <p class="mb-2"><strong>Doporuƒçen√© obleƒçen√≠:</strong> Kv≈Øli rozd√≠l≈Øm teplot mezi destinacemi je kl√≠ƒçov√© vrstven√≠. Zabalte lehk√©, prody≈°n√© obleƒçen√≠ pro Abu Dhabi (s ohledem na m√≠stn√≠ zvyklosti ‚Äì zakryt√° ramena a kolena pro ≈æeny na ve≈ôejnosti a v me≈°it√°ch) a triƒçka, mikiny, svetry a lehkou bundu pro Koreu.</p>
                        <p>Nezapome≈àte na pohodlnou obuv a p≈ô√≠padnƒõ rou≈°ky kv≈Øli "≈ælut√©mu prachu" v Koreji.</p>
                    </div>
                     <div class="tab-pane hidden p-4" id="etiquette-content">
                        <h3 class="text-xl font-bold mb-2">Kulturn√≠ Etiketa</h3>
                        <p class="mb-2"><strong>Korea:</strong> M√≠rn√° √∫klona je standardn√≠ pozdrav. P≈ôi pod√°n√≠ ruky podep≈ôete prav√© p≈ôedlokt√≠ levou rukou. V≈ædy pou≈æ√≠vejte obƒõ ruce p≈ôi p≈ôed√°v√°n√≠ p≈ôedmƒõt≈Ø. V≈ædy si zujte boty p≈ôi vstupu do dom≈Ø, chr√°m≈Ø a nƒõkter√Ωch restaurac√≠. Nenal√©vejte si vlastn√≠ n√°poj, ale nab√≠dnƒõte ostatn√≠m. H≈Ølky nikdy nenech√°vejte zap√≠chnut√© v r√Ω≈æi.</p>
                        <p><strong>Abu Dhabi:</strong> Obl√©kejte se skromnƒõ, zejm√©na p≈ôi n√°v≈°tƒõvƒõ n√°bo≈æensk√Ωch m√≠st (≈æeny zakryt√° ramena, kolena a vlasy). P≈ôi pod√°v√°n√≠ ruky poƒçkejte, a≈æ v√°m ≈æena nab√≠dne ruku. Vyhnƒõte se projev≈Øm n√°klonnosti na ve≈ôejnosti. Bƒõhem ramad√°nu (pokud by se shodoval s va≈°√≠ n√°v≈°tƒõvou) se vyhnƒõte j√≠dlu a pit√≠ na ve≈ôejnosti bƒõhem dne.</p>
                    </div>
                     <div class="tab-pane hidden p-4" id="holidays-content">
                        <h3 class="text-xl font-bold mb-2">St√°tn√≠ Sv√°tky v ≈ò√≠jnu</h3>
                        <p class="mb-2">V√°≈° p≈ô√≠jezd (8. ≈ô√≠jna) se shoduje s koncem sv√°tku <strong>Chuseok</strong> (5.‚Äì8. ≈ô√≠jna). Oƒçek√°vejte zv√Ω≈°enou dopravu p≈ôi cestƒõ z leti≈°tƒõ. Itiner√°≈ô je navr≈æen tak, aby se vyhnul mezimƒõstsk√Ωm p≈ôesun≈Øm v tomto obdob√≠.</p>
                        <p><strong>Den Hangul</strong> (9. ≈ô√≠jna) je dal≈°√≠ st√°tn√≠ sv√°tek v Koreji. Hlavn√≠ turistick√© atrakce jsou obvykle otev≈ôen√© a mohou se konat speci√°ln√≠ kulturn√≠ akce.</p>
                        <p>V Abu Dhabi v ≈ô√≠jnu nejsou obvykle ≈æ√°dn√© velk√© st√°tn√≠ sv√°tky, ale v≈ædy je dobr√© zkontrolovat aktu√°ln√≠ kalend√°≈ô p≈ôed cestou.</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="itinerary" class="mb-16">
            <h2 class="text-3xl font-bold text-center mb-8" style="color: #002D62;">V√°≈° Interaktivn√≠ Itiner√°≈ô</h2>
            <p class="text-center text-gray-600 max-w-3xl mx-auto mb-8">N√≠≈æe naleznete detailn√≠ pl√°n va≈°√≠ cesty den po dni. Ka≈ædou polo≈æku m≈Ø≈æete rozkliknout a zobrazit si podrobnosti o aktivit√°ch, dopravƒõ, u≈æiteƒçn√© odkazy a mapu s vyznaƒçen√Ωmi body z√°jmu.</p>
            <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg">
                <div class="relative" id="timeline-container">
                </div>
            </div>
        </section>

        <section id="budget" class="mb-16">
             <h2 class="text-3xl font-bold text-center mb-8" style="color: #002D62;">Celkov√° Anal√Ωza Rozpoƒçtu</h2>
            <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg">
                 <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-center">
                    <div class="chart-container">
                        <canvas id="budgetDonutChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="costBarChart"></canvas>
                    </div>
                 </div>
                 <div class="text-center mt-8">
                    <p class="text-lg text-gray-600">Celkov√Ω odhadovan√Ω n√°klad na osobu</p>
                    <p class="text-5xl md:text-6xl font-black my-2" style="color: #00A5E3;" id="estimated-cost-display">0 Kƒç</p>
                    <p class="text-lg font-bold" id="budget-status-text"></p>
                </div>
            </div>
        </section>

        <footer class="text-center text-gray-500 mt-12">
            <p>Tento interaktivn√≠ pr≈Øvodce byl vytvo≈ôen na m√≠ru pro va≈°e podzimn√≠ dobrodru≈æstv√≠.</p>
        </footer>
    </div>

    <!-- Lightbox Modal -->
    <div id="lightbox" class="lightbox hidden">
        <span id="close-lightbox" class="close-lightbox">&times;</span>
        <img id="lightbox-img" class="lightbox-content" alt="Full size image">
        <div id="lightbox-caption" class="lightbox-caption"></div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // Global Firebase Variables
        let app, db, auth, storage;
        let currentUserId = null;
        let isAuthReady = false;
        let isUserAnonymous = false;
        let currentBudgetItemToEdit = null; // For budget edit functionality
        let currentDiaryEntryToEdit = null; // For diary edit functionality

        // Global variables provided by Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // Directly use the Firebase config provided by the user in their query
        const firebaseConfig = {
            apiKey: "AIzaSyCCWJKVLVBsBxOf-AZZb6J7RMNY08TAdKs",
            authDomain: "korea-72af1.firebaseapp.com",
            projectId: "korea-72af1",
            storageBucket: "korea-72af1.firebasestorage.app",
            messagingSenderId: "496424582320",
            appId: "1:496424582320:web:a8baa803280cdf5a6bcf75"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        /*
        // D≈ÆLE≈ΩIT√â: N√°sleduj√≠c√≠ pravidla MUS√çTE nastavit ve sv√© konzoli Firebase!
        // T√≠m se vy≈ôe≈°√≠ chyby opr√°vnƒõn√≠.

        // Pravidla pro Firestore Database:
        // (Nastavte v 'Firestore Database' -> 'Rules')
        rules_version = '2';
        service cloud.firestore {
          match /databases/{database}/documents {
            // Pravidla pro VE≈òEJN√Å data (den√≠k, rozpoƒçet)
            // Kdokoli p≈ôihl√°≈°en√Ω (vƒçetnƒõ anonymn√≠ch) m≈Ø≈æe ƒç√≠st.
            // Z√°pis a maz√°n√≠ je povoleno POUZE vlastn√≠kovi z√°znamu.
            // Nov√° cesta: artifacts/{appId}/public/data/{collection}/{documentId}
            match /artifacts/{appId}/public/data/{collection}/{documentId} {
              allow read: if request.auth != null;
              // U≈æivatel m≈Ø≈æe zapisovat/mazat pouze pokud je vlastn√≠kem dokumentu
              allow write: if request.auth != null && request.auth.uid == request.resource.data.ownerId;
            }

            // Pravidla pro SOUKROM√Å data (pokud byste je chtƒõli v budoucnu p≈ôidat)
            // U≈æivatel m≈Ø≈æe ƒç√≠st a zapisovat pouze sv√° vlastn√≠ data
            match /artifacts/{appId}/users/{userId}/{collection=**} {
              allow read: if request.auth != null && request.auth.uid == userId;
              allow write: if request.auth != null && request.auth.uid == userId;
            }
          }
        }

        // Pravidla pro Firebase Cloud Storage:
        // (Nastavte v 'Storage' -> 'Rules')
        rules_version = '2';
        service firebase.storage {
          match /b/{bucket}/o {
            // Pravidla pro fotografie itiner√°≈ôe (ve≈ôejn√© ƒçten√≠, z√°pis/maz√°n√≠ pouze vlastn√≠kem)
            match /artifacts/{appId}/public/photos/{photoId} {
              allow read: if request.auth != null; // Povolit ƒçten√≠ pouze pro p≈ôihl√°≈°en√© u≈æivatele
              // Z√°pis/Maz√°n√≠: Povoleno pouze pro u≈æivatele, kte≈ô√≠ jsou vlastn√≠ky souboru.
              allow write: if request.auth != null && request.auth.uid == request.resource.metadata.ownerId;
            }
          }
        }
        */

        // Itinerary Data
        const itineraryData = [
            { day: 1, date: "Pondƒõl√≠, 6. ≈ô√≠jna", title: "P≈ô√≠let do Abu Dhabi a aklimatizace",
              details: "P≈ô√≠let na mezin√°rodn√≠ leti≈°tƒõ Abu Dhabi (AUH) v 19:05. Po imigraƒçn√≠ kontrole transfer do hotelu. Ubytov√°n√≠ a odpoƒçinek po cestƒõ.",
              transport: "<strong>Taxi:</strong> Nejpohodlnƒõj≈°√≠ zp≈Øsob z leti≈°tƒõ do hotelu. Cena cca 80-100 AED (500-620 CZK).",
              links: {},
              mapData: {
                  center: { lat: 24.4093, lng: 54.4377 }, // Pearl Rotana
                  zoom: 12,
                  markers: [
                      { lat: 24.4330, lng: 54.6511, title: "Leti≈°tƒõ Abu Dhabi (AUH)", description: "Mezin√°rodn√≠ leti≈°tƒõ Abu Dhabi." },
                      { lat: 24.4093, lng: 54.4377, title: "Pearl Rotana Capital Centre (Ubytov√°n√≠)", description: "V√°≈° hotel v Abu Dhabi." }
                  ]
              },
              mapInitialized: false,
              hotel: "Pearl Rotana Capital Centre. Ubytov√°n√≠ je zdarma jako bonus od aerolinek."
            },
            { day: 2, date: "√öter√Ω, 7. ≈ô√≠jna", title: "To nejlep≈°√≠ z Abu Dhabi",
              details: "Celodenn√≠ pr≈Øzkum Abu Dhabi. Dopoledne: N√°v≈°tƒõva Velk√© me≈°ity ≈°ejka Zayeda ‚Äì architektonick√Ω skvost (vstup zdarma, nutn√© dodr≈æet dress code). Obƒõd. Odpoledne: Prohl√≠dka Louvre Abu Dhabi ‚Äì unik√°tn√≠ muzeum umƒõn√≠ a civilizac√≠. Pozdn√≠ odpoledne: N√°v≈°tƒõva Qasr Al Watan (Prezidentsk√Ω pal√°c) ‚Äì pozn√°n√≠ bohat√© historie a kultury SAE.",
              transport: "<strong>Taxi/Careem/Uber:</strong> Nejefektivnƒõj≈°√≠ zp≈Øsob dopravy mezi atrakcemi v Abu Dhabi. Ceny se li≈°√≠ dle vzd√°lenosti.",
              links: { "Velk√° me≈°ita ≈°ejka Zayeda": "https://www.szgmc.gov.ae/en/", "Louvre Abu Dhabi": "https://www.louvreabudhabi.ae/", "Qasr Al Watan": "https://www.qasralwatan.ae/" },
              mapData: {
                  center: { lat: 24.4123, lng: 54.4673 }, // Me≈°ita
                  zoom: 11,
                  markers: [
                      { lat: 24.4123, lng: 54.4673, title: "Velk√° me≈°ita ≈°ejka Zayeda", description: "Jedna z nejvƒõt≈°√≠ch me≈°it na svƒõtƒõ." },
                      { lat: 24.5247, lng: 54.3970, title: "Louvre Abu Dhabi", description: "Muzeum umƒõn√≠ a civilizac√≠." },
                      { lat: 24.4600, lng: 54.3750, title: "Qasr Al Watan", description: "Prezidentsk√Ω pal√°c SAE." },
                      { lat: 24.4093, lng: 54.4377, title: "Pearl Rotana Capital Centre (Ubytov√°n√≠)", description: "V√°≈° hotel v Abu Dhabi." }
                  ]
              },
              mapInitialized: false,
              hotel: "Pearl Rotana Capital Centre. Ubytov√°n√≠ je zdarma jako bonus od aerolinek."
            },
            { day: 3, date: "St≈ôeda, 8. ≈ô√≠jna", title: "Odlet z Abu Dhabi do Soulu",
              details: "R√°no: Brzk√Ω check-out z hotelu. Transfer na mezin√°rodn√≠ leti≈°tƒõ Abu Dhabi (AUH). Odlet z AUH do Soulu (ICN) v 08:35. Let trv√° p≈ôibli≈ænƒõ 8-9 hodin. P≈ô√≠let do Soulu (ICN) bude kolem 17:35 KST (korejsk√©ho ƒçasu).",
              transport: "<strong>Taxi:</strong> Z hotelu na leti≈°tƒõ. Cena cca 80-100 AED (500-620 CZK).",
              links: {},
              mapData: {
                  center: { lat: 24.4330, lng: 54.6511 }, // Leti≈°tƒõ AUH
                  zoom: 12,
                  markers: [
                      { lat: 24.4093, lng: 54.4377, title: "Pearl Rotana Capital Centre (Check-out)", description: "V√°≈° hotel v Abu Dhabi." },
                      { lat: 24.4330, lng: 54.6511, title: "Leti≈°tƒõ Abu Dhabi (AUH)", description: "Mezin√°rodn√≠ leti≈°tƒõ Abu Dhabi." }
                  ]
              },
              mapInitialized: false,
              hotel: "Pearl Rotana Capital Centre. Ubytov√°n√≠ je zdarma jako bonus od aerolinek."
            },
            { day: 4, date: "St≈ôeda, 8. ≈ô√≠jna", title: "P≈ô√≠let do Soulu a aklimatizace",
              details: "P≈ô√≠let na mezin√°rodn√≠ leti≈°tƒõ Incheon (ICN) kolem 17:35 KST (korejsk√©ho ƒçasu) z Abu Dhabi. Po imigraƒçn√≠ kontrole (p≈ôedem vyplnƒõn√° e-Arrival Card) transfer do hotelu. Vzhledem k pozdn√≠ hodinƒõ doporuƒçujeme leti≈°tn√≠ taxi nebo vlak AREX. Ubytov√°n√≠ a odpoƒçinek.",
              transport: "<strong>Leti≈°tn√≠ taxi:</strong> Pevn√© sazby do centra (cca 85k-95k KRW).<br><strong>Vlak AREX:</strong> Express (40 min, 9.5k KRW), All-Stop (60 min, ~4.5k KRW).",
              links: { "Vlak AREX": "https://www.arex.or.kr/main.do", "T-Money karta": "https://www.t-money.co.kr/ncs/pct/tmnyintd/ReadTmyIntdPage.dev" },
              mapData: {
                  center: { lat: 37.5724, lng: 127.0094 }, // Soul N Guesthouse Dongdaemoon
                  zoom: 14,
                  markers: [
                      { lat: 37.4562, lng: 126.8226, title: "Leti≈°tƒõ Incheon (ICN)", description: "Mezin√°rodn√≠ leti≈°tƒõ Incheon." },
                      { lat: 37.5724, lng: 127.0094, title: "Seoul N Guesthouse Dongdaemoon (Ubytov√°n√≠)", description: "Va≈°e ubytov√°n√≠ v Soulu." }
                  ]
              },
              mapInitialized: false,
              hotel: "Seoul N Guesthouse Dongdaemoon, 21, Jong-ro 66ga-gil, Jongno-gu, Jongno-Gu, 03115 Soul, Ji≈æn√≠ Korea (Check-in 8.10.2025, Check-out 12.10.2025, Cena: 5180 CZK)."
            },
            { day: 5, date: "ƒåtvrtek, 9. ≈ô√≠jna (Den Hangul)", title: "Kr√°lovsk√° n√°dhera a tradiƒçn√≠ vesnice",
              details: "Dopoledne: N√°v≈°tƒõva pal√°ce Gyeongbokgung. Zap≈Øjƒçen√≠ Hanboku (tradiƒçn√≠ odƒõv) zajist√≠ voln√Ω vstup a jedineƒçn√Ω z√°≈æitek. Odpoledne: Proch√°zka do tradiƒçn√≠ vesnice Bukchon Hanok. Pozdn√≠ odpoledne: N√°v≈°tƒõva N√°rodn√≠ho muzea Hangul. Veƒçer: Veƒçe≈ôe v Insadongu.",
              transport: "Vyu≈æ√≠vejte prim√°rnƒõ <strong>metro</strong> s kartou T-Money. Stanice Gyeongbokgung (linka 3).",
              links: { "Pal√°c Gyeongbokgung": "https://english.cha.go.kr/html/HtmlPage.do?pg=palace/Gyeongbokgung/Gyeongbokgung.jsp&mn=EN_02_02_01", "N√°rodn√≠ muzeum Hangul": "https://www.hangeul.go.kr/en/" },
              mapData: {
                  center: { lat: 37.5800, lng: 126.9769 }, // Oblast pal√°ce a vesnice
                  zoom: 14,
                  markers: [
                      { lat: 37.5797, lng: 126.9769, title: "Pal√°c Gyeongbokgung", description: "Hlavn√≠ kr√°lovsk√Ω pal√°c dynastie Joseon." },
                      { lat: 37.5826, lng: 126.9837, title: "Vesnice Bukchon Hanok", description: "Tradiƒçn√≠ korejsk√° vesnice s historick√Ωmi domy Hanok." },
                      { lat: 37.5780, lng: 126.9769, title: "N√°rodn√≠ muzeum Hangul", description: "Muzeum vƒõnovan√© korejsk√©mu p√≠smu Hangul." },
                      { lat: 37.5721, lng: 126.9860, title: "Insadong", description: "Oblast zn√°m√° pro tradiƒçn√≠ umƒõn√≠ a suven√Ωry." },
                      { lat: 37.5724, lng: 127.0094, title: "Seoul N Guesthouse Dongdaemoon (Ubytov√°n√≠)", description: "Va≈°e ubytov√°n√≠ v Soulu." }
                  ]
              },
              mapInitialized: false,
              hotel: "Seoul N Guesthouse Dongdaemoon"
            },
            { day: 6, date: "P√°tek, 10. ≈ô√≠jna", title: "K-kultura: Pop, kr√°sa a kuchynƒõ",
              details: "Dopoledne: N√°v≈°tƒõva s√≠dla JYP Entertainment (pouze exteri√©r), pot√© n√°kupy K-Pop zbo≈æ√≠ v Myeongdongu (MusicKorea) nebo Hongdae (Withmuu, Pocaspot). Odpoledne: Pr≈Øzkum r√°je K-Beauty v Myeongdongu. Veƒçer: Voliteln√Ω kurz korejsk√©ho va≈ôen√≠.",
              transport: "P≈ôesuny mezi ƒçtvrtƒõmi pomoc√≠ <strong>metra</strong>.",
              links: { "Seoul Cooking Club": "https://www.seoulcookingclub.com/" },
              mapData: {
                  center: { lat: 37.5598, lng: 126.9860 }, // Myeongdong
                  zoom: 13,
                  markers: [
                      { lat: 37.5615, lng: 126.9904, title: "Myeongdong", description: "N√°kupn√≠ ƒçtvr≈•, centrum K-Beauty a K-Popu." },
                      { lat: 37.5559, lng: 126.9369, title: "Hongdae", description: "Mladistv√° ƒçtvr≈• s umƒõn√≠m, hudbou a kav√°rnami." },
                      { lat: 37.5665, lng: 126.9780, title: "Seoul Cooking Club", description: "≈†kola va≈ôen√≠ (p≈ôibli≈æn√° poloha)." }, // P≈ôesn√° poloha se m≈Ø≈æe li≈°it
                      { lat: 37.5724, lng: 127.0094, title: "Seoul N Guesthouse Dongdaemoon (Ubytov√°n√≠)", description: "Va≈°e ubytov√°n√≠ v Soulu." }
                  ]
              },
              mapInitialized: false,
              hotel: "Seoul N Guesthouse Dongdaemoon"
            },
            { day: 7, date: "Sobota, 11. ≈ô√≠jna", title: "DMZ a podzimn√≠ kouzlo ostrova Nami",
              details: "Celodenn√≠ v√Ωlet. Dopoledne: P≈Øldenn√≠ prohl√≠dka DMZ ze Soulu (rezervovat p≈ôedem, nutn√Ω pas!). Odpoledne: Cesta na malebn√Ω ostrov Nami, proslul√Ω podzimn√≠m list√≠m.",
              transport: "<strong>DMZ:</strong> Organizovan√Ω v√Ωlet s autobusovou dopravou.<br><strong>Ostrov Nami:</strong> P≈ô√≠m√Ω autobus z Insadongu nebo vlak ITX do Gapyeong Station a n√°slednƒõ m√≠stn√≠ doprava (bus/taxi) k trajektu.",
              links: { "DMZ Tour (doporuƒçen√≠)": "https://www.vviptravel.com/dmz-tours", "Ostrov Nami": "https://www.namisum.com/en/" },
              mapData: {
                  center: { lat: 37.8967, lng: 127.0097 }, // Oblast DMZ
                  zoom: 9,
                  markers: [
                      { lat: 37.9567, lng: 126.7380, title: "DMZ (Demilitarizovan√° z√≥na)", description: "Hranice mezi Severn√≠ a Ji≈æn√≠ Koreou." },
                      { lat: 37.7946, lng: 127.5250, title: "Ostrov Nami", description: "Malebn√Ω ostrov proslul√Ω podzimn√≠m list√≠m." },
                      { lat: 37.5724, lng: 127.0094, title: "Seoul N Guesthouse Dongdaemoon (Ubytov√°n√≠)", description: "Va≈°e ubytov√°n√≠ v Soulu." }
                  ]
              },
              mapInitialized: false,
              hotel: "Seoul N Guesthouse Dongdaemoon"
            },
            { day: 8, date: "Nedƒõle, 12. ≈ô√≠jna", title: "Check-out ze Soulu a cesta do Pusanu",
              details: "Dopoledne: Check-out z ubytov√°n√≠ v Soulu. P≈ôesun vysokorychlostn√≠m vlakem KTX ze Soulu do Pusanu. Odpoledne: Ubytov√°n√≠ v Pusanu. Veƒçer: Relaxaƒçn√≠ proch√°zka po pl√°≈æi Haeundae.",
              transport: "<strong>KTX vlak:</strong> Cca 2.5h, rezervovat s p≈ôedstihem.",
              links: { "Rezervace KTX (Korail)": "https://www.letskorail.com/ebizbf/EbizbfForeign_pr16100.do", "Turismus Pusan": "https://www.visitbusan.net/en/" },
              mapData: {
                  center: { lat: 35.1666, lng: 129.1666 }, // Pusan
                  zoom: 12,
                  markers: [
                      { lat: 37.5724, lng: 127.0094, title: "Seoul N Guesthouse Dongdaemoon (Check-out)", description: "Va≈°e ubytov√°n√≠ v Soulu." },
                      { lat: 35.1557, lng: 129.0597, title: "Seomyeon Brown-dot hotel Gold (Ubytov√°n√≠)", description: "Va≈°e ubytov√°n√≠ v Pusanu." },
                      { lat: 35.1633, lng: 129.1650, title: "Pl√°≈æ Haeundae", description: "Jedna z nejzn√°mƒõj≈°√≠ch pl√°≈æ√≠ v Pusanu." },
                      { lat: 35.1158, lng: 129.0390, title: "Pusan Station (KTX)", description: "Hlavn√≠ vlakov√© n√°dra≈æ√≠ v Pusanu." }
                  ]
              },
              mapInitialized: false,
              hotel: "Seomyeon Brown-dot hotel Gold, 20-11, Hwangnyeong-daero 7beon-gil, Busanjin-gu, Busanjin-Gu, 47353 Pusan, Ji≈æn√≠ Korea (P≈ô√≠jezd 12.10.2025, Odjezd 15.10.2025, Cena: 4730 CZK)."
            },
            { day: 9, date: "Pondƒõl√≠, 13. ≈ô√≠jna", title: "Umƒõn√≠ a chutƒõ Pusanu",
              details: "Dopoledne: N√°v≈°tƒõva barevn√© kulturn√≠ vesnice Gamcheon. Obƒõd: ƒåerstv√© mo≈ôsk√© plody na ru≈°n√©m ryb√≠m trhu Jagalchi. Odpoledne: N√°kupy a pouliƒçn√≠ j√≠dlo v Nampo-dongu. Veƒçer: Autentick√© korejsk√© BBQ nebo popul√°rn√≠ 'Chimaek'.",
              transport: "Vyu≈æit√≠ m√≠stn√≠ho <strong>metra a autobus≈Ø</strong>.",
              links: {},
              mapData: {
                  center: { lat: 35.0990, lng: 129.0100 }, // Oblast Gamcheon
                  zoom: 14,
                  markers: [
                      { lat: 35.0990, lng: 129.0100, title: "Kulturn√≠ vesnice Gamcheon", description: "Barevn√° vesnice na kopci s umƒõleck√Ωmi instalacemi." },
                      { lat: 35.0980, lng: 129.0270, title: "Ryb√≠ trh Jagalchi", description: "Nejvƒõt≈°√≠ ryb√≠ trh v Koreji." },
                      { lat: 35.0970, lng: 129.0290, title: "Nampo-dong", description: "N√°kupn√≠ a z√°bavn√≠ ƒçtvr≈• v Pusanu." },
                      { lat: 35.1557, lng: 129.0597, title: "Seomyeon Brown-dot hotel Gold (Ubytov√°n√≠)", description: "Va≈°e ubytov√°n√≠ v Pusanu." }
                  ]
              },
              mapInitialized: false,
              hotel: "Seomyeon Brown-dot hotel Gold"
            },
            { day: 10, date: "√öter√Ω, 14. ≈ô√≠jna", title: "Jednodenn√≠ v√Ωlet do Gyeongju",
              details: "Celodenn√≠ v√Ωlet vlakem KTX do Gyeongju, 'muzea bez zd√≠'. N√°v≈°tƒõva pam√°tek UNESCO: chr√°m Bulguksa, jeskynƒõ Seokguram a kr√°lovsk√© hrobky v parku Tumuli. Veƒçer n√°vrat do Pusanu.",
              transport: "Kr√°tk√° cesta (cca 30 min) <strong>vlakem KTX</strong> z Busan Station.",
              links: { "Historick√© oblasti Gyeongju": "https://english.visitkorea.or.kr/svc/contents/contentsView.do?vcontsId=140669" },
              mapData: {
                  center: { lat: 35.8437, lng: 129.2173 }, // Gyeongju
                  zoom: 11,
                  markers: [
                      { lat: 35.7950, lng: 129.3300, title: "Chr√°m Bulguksa", description: "Buddhistick√Ω chr√°m UNESCO." },
                      { lat: 35.7800, lng: 129.3400, title: "Jeskynƒõ Seokguram", description: "Jeskynn√≠ svatynƒõ UNESCO s Buddhou." },
                      { lat: 35.8360, lng: 129.2150, title: "Park Tumuli (Daereungwon)", description: "Park s kr√°lovsk√Ωmi hrobkami." },
                      { lat: 35.1557, lng: 129.0597, title: "Seomyeon Brown-dot hotel Gold (Ubytov√°n√≠)", description: "Va≈°e ubytov√°n√≠ v Pusanu." }
                  ]
              },
              mapInitialized: false,
              hotel: "Seomyeon Brown-dot hotel Gold"
            },
            { day: 11, date: "St≈ôeda, 15. ≈ô√≠jna", title: "Cesta na ostrov ƒåed≈æu",
              details: "Dlouh√Ω cestovn√≠ den. Dopoledne: Cesta autobusem z Pusanu do Wando. Odpoledne: Trajekt z p≈ô√≠stavu Wando na ostrov ƒåed≈æu. Veƒçer: P≈ô√≠jezd na ƒåed≈æu, transfer do hotelu.",
              transport: "<strong>Expresn√≠ autobus</strong> Pusan -> Wando (cca 4.5h).<br><strong>Trajekt Hanil Express</strong> Wando -> ƒåed≈æu (cca 1.5-3h). Nutn√© potvrdit j√≠zdn√≠ ≈ô√°d den p≈ôedem!",
              links: { "Rezervace trajektu": "http://www.ferryto.com/hanilexpress.html" },
              mapData: {
                  center: { lat: 34.3200, lng: 126.7000 }, // Mezi Wando a Jeju
                  zoom: 8,
                  markers: [
                      { lat: 35.1557, lng: 129.0597, title: "Seomyeon Brown-dot hotel Gold (Check-out)", description: "Va≈°e ubytov√°n√≠ v Pusanu." },
                      { lat: 34.3160, lng: 126.7570, title: "P≈ô√≠stav Wando", description: "P≈ô√≠stav pro trajekty na ƒåed≈æu." },
                      { lat: 33.5141, lng: 126.5295, title: "P≈ô√≠stav ƒåed≈æu", description: "Hlavn√≠ p≈ô√≠stav na ostrovƒõ ƒåed≈æu." },
                      { lat: 33.5097, lng: 126.5219, title: "I-Jin Hotel (Ubytov√°n√≠)", description: "Va≈°e ubytov√°n√≠ na ostrovƒõ ƒåed≈æu." }
                  ]
              },
              mapInitialized: false,
              hotel: "I-Jin Hotel, 4, Sindae-ro 22-gil, Jeju City, 63136 ƒåed≈æu, Ji≈æn√≠ Korea (P≈ô√≠jezd 15.10.2025, Odjezd 18.10.2025, Cena: 6430 CZK)."
            },
            { day: 12, date: "ƒåtvrtek, 16. ≈ô√≠jna", title: "P≈ô√≠rodn√≠ divy ƒåed≈æu - Hallasan",
              details: "Dopoledne: T√∫ra v n√°rodn√≠m parku Hallasan, nejvy≈°≈°√≠ ho≈ôe Ji≈æn√≠ Koreje. Doporuƒçuj√≠ se snaz≈°√≠ stezky (Yeongsil, Eorimok). Odpoledne: N√°v≈°tƒõva l√°vov√© jeskynƒõ Manjanggul. Volitelnƒõ pro nete≈ô: N√°v≈°tƒõva tematick√©ho parku jako Snoopy Garden.",
              transport: "Vyu≈æit√≠ m√≠stn√≠ch <strong>autobus≈Ø nebo taxi</strong>.",
              links: { "NP Hallasan": "https://www.jeju.go.kr/hallasan/index.do" },
              mapData: {
                  center: { lat: 33.3625, lng: 126.5330 }, // Hallasan
                  zoom: 10,
                  markers: [
                      { lat: 33.3625, lng: 126.5330, title: "Hora Hallasan", description: "Nejvy≈°≈°√≠ hora Ji≈æn√≠ Koreje a n√°rodn√≠ park." },
                      { lat: 33.5280, lng: 126.7690, title: "Jeskynƒõ Manjanggul", description: "Jedna z nejdel≈°√≠ch l√°vov√Ωch trubic na svƒõtƒõ." },
                      { lat: 33.4570, lng: 126.7320, title: "Snoopy Garden", description: "Tematick√Ω park Snoopy." },
                      { lat: 33.5097, lng: 126.5219, title: "I-Jin Hotel (Ubytov√°n√≠)", description: "Va≈°e ubytov√°n√≠ na ostrovƒõ ƒåed≈æu." }
                  ]
              },
              mapInitialized: false,
              hotel: "I-Jin Hotel"
            },
            { day: 13, date: "P√°tek, 17. ≈ô√≠jna", title: "V√Ωchodn√≠ pob≈ôe≈æ√≠ ƒåed≈æu a ƒçajov√© muzeum",
              details: "Dopoledne: V√Ωstup na sopeƒçn√Ω ku≈æel Seongsan Ilchulbong (UNESCO). Odpoledne: N√°v≈°tƒõva vodop√°d≈Ø Jeongbang. Pozdn√≠ odpoledne: N√°v≈°tƒõva ƒçajov√©ho muzea O'Sulloc, kde se dozv√≠te o historii korejsk√©ho ƒçaje a ochutn√°te m√≠stn√≠ speciality. Veƒçer: Odpoƒçinek na malebn√© pl√°≈æi Woljeongri nebo Hamdeok.",
              transport: "Pro p≈ôesun k O'Sulloc Tea Museum z Jeju City (kde je v√°≈° hotel) pou≈æijte <strong>Red Express Bus linku 151</strong> z Jeju Bus Terminal. Cesta trv√° p≈ôibli≈ænƒõ 50-52 minut a stoj√≠ 2 100 - 2 700 KRW. Pro ostatn√≠ p≈ôesuny po ostrovƒõ vyu≈æ√≠vejte m√≠stn√≠ <strong>autobusy nebo taxi</strong>, ide√°lnƒõ s aplikacemi KakaoMap nebo Naver Map.",
              links: { "Muzeum O'Sulloc": "https://www.osulloc.com/kr/ko/museum" },
              mapData: {
                  center: { lat: 33.4350, lng: 126.9400 }, // Seongsan
                  zoom: 11,
                  markers: [
                      { lat: 33.4583, lng: 126.9427, title: "Seongsan Ilchulbong", description: "Sopeƒçn√Ω kr√°ter UNESCO s √∫chvatn√Ωmi v√Ωhledy." },
                      { lat: 33.2450, lng: 126.5650, title: "Vodop√°dy Jeongbang", description: "Vodop√°dy padaj√≠c√≠ p≈ô√≠mo do oce√°nu." },
                      { lat: 33.3030, lng: 126.2880, title: "Muzeum O'Sulloc", description: "Muzeum ƒçaje s ƒçajov√Ωmi plant√°≈æemi." },
                      { lat: 33.5570, lng: 126.7800, title: "Pl√°≈æ Woljeongri", description: "Kr√°sn√° pl√°≈æ s tyrkysovou vodou." },
                      { lat: 33.5410, lng: 126.6660, title: "Pl√°≈æ Hamdeok", description: "Obl√≠ben√° pl√°≈æ s b√≠l√Ωm p√≠skem." },
                      { lat: 33.5097, lng: 126.5219, title: "I-Jin Hotel (Ubytov√°n√≠)", description: "Va≈°e ubytov√°n√≠ na ostrovƒõ ƒåed≈æu." }
                  ]
              },
              mapInitialized: false,
              hotel: "I-Jin Hotel"
            },
            { day: 14, date: "Sobota, 18. ≈ô√≠jna", title: "N√°vrat do Soulu a voln√Ω program",
              details: "Dopoledne: Vnitrost√°tn√≠ let z ƒåed≈æu (CJU) do Soulu (GMP, ~1h 10m). Odpoledne: Po ubytov√°n√≠ voln√Ω program. M≈Ø≈æete se vr√°tit na obl√≠ben√° n√°kupn√≠ m√≠sta nebo prozkoumat novou ƒçtvr≈•.",
              transport: "<strong>Vnitrost√°tn√≠ let</strong> (rezervovat s p≈ôedstihy).",
              links: {},
              mapData: {
                  center: { lat: 37.5665, lng: 126.9780 }, // Soul
                  zoom: 11,
                  markers: [
                      { lat: 33.5141, lng: 126.4930, title: "Leti≈°tƒõ ƒåed≈æu (CJU)", description: "Leti≈°tƒõ na ostrovƒõ ƒåed≈æu." },
                      { lat: 37.5580, lng: 126.7940, title: "Leti≈°tƒõ Gimpo (GMP)", description: "Vnitrost√°tn√≠ leti≈°tƒõ v Soulu." },
                      { lat: 37.5665, lng: 126.9780, title: "Centrum Soulu", description: "Oblast ubytov√°n√≠ v Soulu." },
                      { lat: 37.5658, lng: 127.0084, title: "K-Guesthouse Dongdaemun Premium (Ubytov√°n√≠)", description: "Va≈°e ubytov√°n√≠ v Soulu." }
                  ]
              },
              mapInitialized: false,
              hotel: "K-Guesthouse Dongdaemun Premium, 213, Jangchungdan-ro, Jung-gu, Jung-Gu, 04615 Soul, Ji≈æn√≠ Korea (P≈ô√≠jezd 18.10.2025, Odjezd 21.10.2025, Cena: 4197 CZK)."
            },
            { day: 15, date: "Nedƒõle, 19. ≈ô√≠jna", title: "Posledn√≠ kulturn√≠ z√°≈æitky",
              details: "Dopoledne: Proch√°zka ƒçtvrt√≠ Insadong, n√°kup tradiƒçn√≠ch suven√Ωr≈Ø. Volitelnƒõ: Vyzkou≈°ejte klidn√Ω ƒçajov√Ω ob≈ôad. Odpoledne: V√Ωlet lanovkou na N Seoul Tower pro dechberouc√≠ v√Ωhled. Veƒçer: Slavnostn√≠ rozluƒçkov√° veƒçe≈ôe ‚Äì tradiƒçn√≠ Hanjeongsik nebo pouliƒçn√≠ j√≠dlo v Myeongdongu.",
              transport: "Vyu≈æit√≠ m√≠stn√≠ho <strong>metra a lanovky</strong>.",
              links: { "N Seoul Tower": "https://www.seoultower.co.kr/eng/" },
              mapData: {
                  center: { lat: 37.5500, lng: 126.9880 }, // N Seoul Tower
                  zoom: 13,
                  markers: [
                      { lat: 37.5721, lng: 126.9860, title: "Insadong", description: "Oblast s tradiƒçn√≠mi suven√Ωry a ƒçajovnami." },
                      { lat: 37.5512, lng: 126.9882, title: "N Seoul Tower", description: "Vƒõ≈æ s panoramatick√Ωm v√Ωhledem na Soul." },
                      { lat: 37.5615, lng: 126.9904, title: "Myeongdong", description: "Oblast pro veƒçe≈ôi a pouliƒçn√≠ j√≠dlo." },
                      { lat: 37.5658, lng: 127.0084, title: "K-Guesthouse Dongdaemun Premium (Ubytov√°n√≠)", description: "Va≈°e ubytov√°n√≠ v Soulu." }
                  ]
              },
              mapInitialized: false,
              hotel: "K-Guesthouse Dongdaemun Premium"
            },
            { day: 16, date: "Pondƒõl√≠, 20. ≈ô√≠jna", title: "Voln√Ω den a posledn√≠ n√°kupy",
              details: "Cel√Ω den je vyhrazen pro flexibiln√≠ aktivity. Ide√°ln√≠ pro n√°kupy K-Pop a K-Beauty d√°rk≈Ø na posledn√≠ chv√≠li, n√°v≈°tƒõvu muzea, kter√© jste nestihli, nebo jen relaxaci.",
              transport: "Vyu≈æit√≠ <strong>metra a autobus≈Ø</strong>.",
              links: {},
              mapData: {
                  center: { lat: 37.5665, lng: 126.9780 }, // Soul
                  zoom: 12,
                  markers: [
                      { lat: 37.5665, lng: 126.9780, title: "Soul", description: "Voln√Ω den v Soulu." },
                      { lat: 37.5658, lng: 127.0084, title: "K-Guesthouse Dongdaemun Premium (Ubytov√°n√≠)", description: "Va≈°e ubytov√°n√≠ v Soulu." }
                  ]
              },
              mapInitialized: false,
              hotel: "K-Guesthouse Dongdaemun Premium"
            },
            { day: 17, date: "√öter√Ω, 21. ≈ô√≠jna", title: "Odlet dom≈Ø",
              details: "Dopoledne: Posledn√≠ korejsk√° sn√≠danƒõ a balen√≠. Odpoledne: Vƒçasn√Ω transfer na leti≈°tƒõ Incheon (ICN) s dostateƒçnou rezervou pro odlet v 18:30.",
              transport: "<strong>Vlak AREX</strong> nebo <strong>leti≈°tn√≠ autobus</strong> na leti≈°tƒõ ICN.",
              links: {},
              mapData: {
                  center: { lat: 37.4562, lng: 126.8226 }, // Leti≈°tƒõ Incheon
                  zoom: 10,
                  markers: [
                      { lat: 37.4562, lng: 126.8226, title: "Leti≈°tƒõ Incheon (ICN)", description: "Mezin√°rodn√≠ leti≈°tƒõ Incheon." },
                      { lat: 37.5658, lng: 127.0084, title: "K-Guesthouse Dongdaemun Premium (Ubytov√°n√≠)", description: "Va≈°e ubytov√°n√≠ v Soulu." }
                  ]
              },
              mapInitialized: false,
              hotel: "K-Guesthouse Dongdaemun Premium"
            }
        ];

        // Funkce pro inicializaci mapy (vol√°na Google Maps API)
        window.initMap = function() {
            console.log("Google Maps API naƒçteno.");
        };

        let maps = {}; // Objekt pro ukl√°d√°n√≠ instanc√≠ map

        const palette = { blue: '#00A5E3', teal: '#8DD7BF', pink: '#FF96C5', red: '#FF5768', orange: '#FFBF65', yellow: '#F8E16C', purple: '#A020F0' };

        const wrapLabel = (label) => {
            const maxLength = 16;
            if (typeof label !== 'string' || label.length <= maxLength) return label;
            const words = label.split(' ');
            const lines = [];
            let currentLine = '';
            for (const word of words) {
                if ((currentLine + ' ' + word).trim().length > maxLength) { lines.push(currentLine.trim()); currentLine = word; }
                else { currentLine = (currentLine + ' ' + word).trim(); }
            }
            if (currentLine) lines.push(currentLine.trim());
            return lines;
        };

        const tooltipTitleCallback = (tooltipItems) => {
            const item = tooltipItems[0];
            let label = item.chart.data.labels[item.dataIndex];
            return Array.isArray(label) ? label.join(' ') : label;
        };

        // Celkov√© n√°klady na ubytov√°n√≠ pro v≈°echny osoby (z dat itiner√°≈ôe)
        const totalAccommodationCost = 20537;
        const numTravelers = 3;

        const abuDhabiTransportPerPerson = Math.round(3100 / numTravelers);
        const abuDhabiActivitiesPerPerson = Math.round(2480 / numTravelers);
        const abuDhabiFoodPerPerson = Math.round(4030 / numTravelers);
        const abuDhabiMiscPerPerson = Math.round(620 / numTravelers);

        const plannedBudgetValues = { // Per person
            'Ubytov√°n√≠': Math.round(totalAccommodationCost / numTravelers),
            'Doprava (Mezimƒõsto)': 7000 + abuDhabiTransportPerPerson,
            'Doprava (M√≠stn√≠)': 3612,
            'Aktivity': 4100 + abuDhabiActivitiesPerPerson,
            'J√≠dlo': 7700 + abuDhabiFoodPerPerson,
            'R≈Øzn√©': 5920 + abuDhabiMiscPerPerson
        };

        const plannedBudgetLabels = Object.keys(plannedBudgetValues);
        const plannedBudgetChartData = Object.values(plannedBudgetValues);

        let estimatedCostPerPerson = plannedBudgetChartData.reduce((sum, val) => sum + val, 0);
        estimatedCostPerPerson = Math.round(estimatedCostPerPerson);

        // Currency exchange rates to CZK
        const exchangeRatesToCZK = {
            'CZK': 1,
            'EUR': 25, // Approximate
            'USD': 23, // Approximate
            'AED': 6.2, // From previous prompt
            'KRW': 0.0197 // From previous prompt (1 CZK = 50.67 KRW)
        };

        // --- Utility Functions for Modals ---
        function showCustomConfirm(message, onConfirmCallback) {
            const modal = document.getElementById('custom-confirm-modal');
            const msgElement = document.getElementById('confirm-message');
            const yesBtn = document.getElementById('confirm-yes');
            const noBtn = document.getElementById('confirm-no');

            msgElement.textContent = message;
            modal.classList.remove('hidden');

            const handleYes = () => {
                onConfirmCallback(true);
                modal.classList.add('hidden');
                yesBtn.removeEventListener('click', handleYes);
                noBtn.removeEventListener('click', handleNo);
            };

            const handleNo = () => {
                onConfirmCallback(false);
                modal.classList.add('hidden');
                yesBtn.removeEventListener('click', handleYes);
                noBtn.removeEventListener('click', handleNo);
            };

            yesBtn.addEventListener('click', handleYes);
            noBtn.addEventListener('click', handleNo);
        }

        function showCustomAlert(message) {
            const modal = document.getElementById('custom-alert-modal');
            const msgElement = document.getElementById('alert-message');
            const okBtn = document.getElementById('alert-ok');

            msgElement.textContent = message;
            modal.classList.remove('hidden');

            const handleOk = () => {
                modal.classList.add('hidden');
                okBtn.removeEventListener('click', handleOk);
            };

            okBtn.addEventListener('click', handleOk);
        }

        // --- Firebase Auth Functions ---
        async function initializeFirebase() {
            if (Object.keys(firebaseConfig).length === 0) {
                console.warn("Firebase config is empty. Running in offline mode.");
                isAuthReady = true;
                document.getElementById('user-id-display').textContent = `U≈æivatel: Offline (Firebase konfigurace chyb√≠)`;
                document.getElementById('login-modal').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                document.getElementById('show-login-form-btn').classList.add('hidden');
                document.getElementById('logout-btn').classList.add('hidden');
                // Hide editable content sections if Firebase is not active
                document.querySelectorAll('.editable-content').forEach(el => el.classList.add('hidden'));
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                storage = getStorage(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        isUserAnonymous = user.isAnonymous;
                        console.log(`DEBUG: U≈æivatel p≈ôihl√°≈°en. ID: ${currentUserId}, Anonymn√≠: ${isUserAnonymous}`);

                        if (user.isAnonymous) {
                            document.getElementById('user-id-display').textContent = `U≈æivatel: Anonymn√≠ (${currentUserId.substring(0, 8)}...)`;
                            document.getElementById('show-login-form-btn').classList.remove('hidden');
                            document.getElementById('logout-btn').classList.add('hidden');
                            // Hide editable content for anonymous users
                            document.querySelectorAll('.editable-content').forEach(el => el.classList.add('hidden'));
                        } else {
                            document.getElementById('user-id-display').textContent = `U≈æivatel: ${user.email}`;
                            document.getElementById('show-login-form-btn').classList.add('hidden');
                            document.getElementById('logout-btn').classList.remove('hidden');
                            // Show editable content for authenticated users
                            document.querySelectorAll('.editable-content').forEach(el => el.classList.remove('hidden'));
                        }
                        isAuthReady = true;
                        document.getElementById('login-modal').classList.add('hidden');
                        document.getElementById('main-content').classList.remove('hidden');
                        console.log(`DEBUG: Auth state ready. Setting up Firestore listeners.`);
                        setupFirestoreListeners(); // Setup listeners AFTER auth is ready
                    } else {
                        // If no user, try to sign in anonymously
                        try {
                            await signInAnonymously(auth);
                            console.log("DEBUG: Signed in anonymously via onAuthStateChanged fallback.");
                        } catch (anonError) {
                            console.error("DEBUG: Error signing in anonymously during fallback:", anonError);
                            currentUserId = null;
                            isUserAnonymous = true; // Still consider them anonymous for UI purposes if auth failed
                            isAuthReady = true;
                            document.getElementById('user-id-display').textContent = `U≈æivatel: Offline (Firebase nen√≠ aktivn√≠, chyba autentizace)`;
                            document.getElementById('login-modal').classList.add('hidden');
                            document.getElementById('main-content').classList.remove('hidden');
                            document.getElementById('show-login-form-btn').classList.add('hidden');
                            document.getElementById('logout-btn').classList.add('hidden');
                            document.querySelectorAll('.editable-content').forEach(el => el.classList.add('hidden'));
                        }
                    }
                });

                // Attempt initial sign-in if no user is already active
                if (!auth.currentUser) {
                    if (initialAuthToken) {
                        try {
                            await signInWithCustomToken(auth, initialAuthToken);
                            console.log("DEBUG: Signed in with custom token (initial).");
                        } catch (error) {
                            console.error("DEBUG: Error signing in with custom token (initial), falling back to anonymous:", error);
                            // onAuthStateChanged will handle the anonymous sign-in if custom token fails
                        }
                    } else {
                        // onAuthStateChanged will handle the anonymous sign-in if no token
                    }
                }

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                isAuthReady = true;
                document.getElementById('user-id-display').textContent = `U≈æivatel: Offline (Firebase nen√≠ aktivn√≠, chyba inicializace)`;
                document.getElementById('login-modal').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                document.getElementById('show-login-form-btn').classList.add('hidden');
                document.getElementById('logout-btn').classList.add('hidden');
                document.querySelectorAll('.editable-content').forEach(el => el.classList.add('hidden'));
            }
        }

        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            const loginError = document.getElementById('login-error');
            loginError.textContent = '';

            try {
                await signInWithEmailAndPassword(auth, email, password);
                document.getElementById('login-modal').classList.add('hidden');
                showCustomAlert('P≈ôihl√°≈°en√≠ √∫spƒõ≈°n√©!');
            } catch (error) {
                console.error("Login error:", error);
                loginError.textContent = `Chyba p≈ôihl√°≈°en√≠: ${error.message}`;
            }
        }

        // Removed handleRegister function as the button is removed.
        // If you need registration functionality later, you'll need to re-add the button and this function.

        async function handleLogout() {
            showCustomConfirm('Opravdu se chcete odhl√°sit?', async (confirmed) => {
                if (confirmed) {
                    try {
                        await signOut(auth);
                        // After logging out, immediately sign in anonymously
                        await signInAnonymously(auth);
                        showCustomAlert('√öspƒõ≈°nƒõ odhl√°≈°eno.');
                        document.getElementById('login-modal').classList.add('hidden'); // Ensure modal is hidden
                    } catch (error) {
                        console.error("Logout error:", error);
                        showCustomAlert(`Chyba odhl√°≈°en√≠: ${error.message}`);
                    }
                }
            });
        }

        function showLoginForm() {
            if (auth.currentUser && !auth.currentUser.isAnonymous) {
                showCustomAlert('Jste ji≈æ p≈ôihl√°≈°eni jako registrovan√Ω u≈æivatel.');
                return;
            }
            document.getElementById('login-modal').classList.remove('hidden');
            document.getElementById('login-error').textContent = '';
            document.getElementById('email-input').value = '';
            document.getElementById('password-input').value = '';
        }

        // --- Firestore & Storage Functions ---
        // Changed to point to the public collection with 'data' segment
        function getDiaryEntriesCollectionRef() {
            return collection(db, `artifacts/${appId}/public/data/diaryEntries`);
        }

        // Changed to point to the public collection with 'data' segment
        function getBudgetItemsCollectionRef() {
            return collection(db, `artifacts/${appId}/public/data/budgetItems`);
        }

        function getPhotoStorageRef(photoId) {
            return ref(storage, `artifacts/${appId}/public/photos/${photoId}`);
        }

        async function uploadPhoto(file, ownerId) {
            const photoId = Date.now().toString() + '-' + file.name;
            const storageRef = getPhotoStorageRef(photoId);
            const metadata = { customMetadata: { ownerId: ownerId } };
            const snapshot = await uploadBytes(storageRef, file, metadata);
            const photoUrl = await getDownloadURL(snapshot.ref);
            return { id: photoId, url: photoUrl };
        }

        async function addDiaryEntry(dayId, text, photoFiles, photoCaption) {
            if (!currentUserId || isUserAnonymous) {
                showCustomAlert('Pro p≈ôid√°n√≠ z√°znamu se mus√≠te p≈ôihl√°sit registrovan√Ωm √∫ƒçtem.');
                return;
            }

            const photos = [];
            for (const file of photoFiles) {
                try {
                    const photo = await uploadPhoto(file, currentUserId);
                    photos.push(photo);
                } catch (error) {
                    console.error("Error uploading photo:", error);
                    showCustomAlert(`Chyba p≈ôi nahr√°v√°n√≠ fotografie: ${file.name}: ${error.message}`);
                    return; // Stop if any photo upload fails
                }
            }

            try {
                await addDoc(getDiaryEntriesCollectionRef(), {
                    day: dayId,
                    text: text,
                    photos: photos, // Store array of photo objects
                    photoCaption: photoCaption,
                    timestamp: Date.now(),
                    ownerId: currentUserId
                });
                showCustomAlert('Z√°znam den√≠ku √∫spƒõ≈°nƒõ p≈ôid√°n!');
            } catch (error) {
                console.error("Error adding diary entry:", error);
                showCustomAlert(`Chyba p≈ôi p≈ôid√°v√°n√≠ z√°znamu: ${error.message}`);
            }
        }

        async function updateDiaryEntry(entryId, dayId, text, newPhotoFiles, photoCaption, existingPhotos) {
            if (!currentUserId || isUserAnonymous) {
                showCustomAlert('Pro √∫pravu z√°znamu se mus√≠te p≈ôihl√°sit registrovan√Ωm √∫ƒçtem.');
                return;
            }

            let updatedPhotos = [...(existingPhotos || [])]; // Start with existing photos

            for (const file of newPhotoFiles) {
                try {
                    const photo = await uploadPhoto(file, currentUserId);
                    updatedPhotos.push(photo); // Append new photos
                } catch (error) {
                    console.error("Error uploading new photo:", error);
                    showCustomAlert(`Chyba p≈ôi nahr√°v√°n√≠ nov√© fotografie: ${file.name}: ${error.message}`);
                    return;
                }
            }

            try {
                const entryRef = doc(getDiaryEntriesCollectionRef(), entryId);
                await updateDoc(entryRef, {
                    text: text,
                    photos: updatedPhotos, // Update with new array
                    photoCaption: photoCaption,
                    timestamp: Date.now(),
                    ownerId: currentUserId // Ensure ownerId remains
                });
                showCustomAlert('Z√°znam den√≠ku √∫spƒõ≈°nƒõ aktualizov√°n!');
            } catch (error) {
                console.error("Error updating diary entry:", error);
                showCustomAlert(`Chyba p≈ôi aktualizaci z√°znamu: ${error.message}`);
            }
        }

        async function deleteDiaryEntry(entryId, photos) {
            if (!currentUserId || isUserAnonymous) {
                showCustomAlert('Pro smaz√°n√≠ z√°znamu se mus√≠te p≈ôihl√°sit registrovan√Ωm √∫ƒçtem.');
                return;
            }

            showCustomConfirm('Opravdu chcete smazat tento z√°znam den√≠ku a v≈°echny jeho fotografie?', async (confirmed) => {
                if (confirmed) {
                    try {
                        // Delete associated photos from Storage
                        if (photos && photos.length > 0) {
                            for (const photo of photos) {
                                try {
                                    await deleteObject(getPhotoStorageRef(photo.id));
                                } catch (error) {
                                    console.warn(`Could not delete photo ${photo.id}:`, error);
                                }
                            }
                        }
                        // Delete the diary entry document
                        await deleteDoc(doc(getDiaryEntriesCollectionRef(), entryId));
                        showCustomAlert('Z√°znam den√≠ku √∫spƒõ≈°nƒõ smaz√°n!');
                    } catch (error) {
                        console.error("Error deleting diary entry:", error);
                        showCustomAlert(`Chyba p≈ôi maz√°n√≠ z√°znamu: ${error.message}`);
                    }
                }
            });
        }

        function convertCurrency(amount, fromCurrency, toCurrency = 'CZK') {
            if (fromCurrency === toCurrency) {
                return amount;
            }
            const amountInCZK = amount * exchangeRatesToCZK[fromCurrency];
            return amountInCZK / exchangeRatesToCZK[toCurrency];
        }

        async function addBudgetItem(dayId, description, category, people, currency, amount, amountCZK) {
            if (!currentUserId || isUserAnonymous) {
                showCustomAlert('Pro p≈ôid√°n√≠ polo≈æky rozpoƒçtu se mus√≠te p≈ôihl√°sit registrovan√Ωm √∫ƒçtem.');
                return;
            }
            try {
                await addDoc(getBudgetItemsCollectionRef(), { // Pou≈æ√≠v√°me ve≈ôejnou kolekci
                    day: dayId, // Associate with day
                    description: description,
                    category: category,
                    people: parseInt(people),
                    currency: currency,
                    amount: parseFloat(amount),
                    amountCZK: parseFloat(amountCZK),
                    timestamp: Date.now(),
                    ownerId: currentUserId // D≈Øle≈æit√©: Ulo≈æen√≠ ownerId do dokumentu
                });
                showCustomAlert('Polo≈æka rozpoƒçtu √∫spƒõ≈°nƒõ p≈ôid√°na!');
            } catch (error) {
                console.error("Error adding budget item:", error);
                showCustomAlert(`Chyba p≈ôi p≈ôid√°v√°n√≠ polo≈æky: ${error.message}`);
            }
        }

        async function updateBudgetItem(itemId, dayId, description, category, people, currency, amount, amountCZK) {
            if (!currentUserId || isUserAnonymous) {
                showCustomAlert('Pro √∫pravu polo≈æky rozpoƒçtu se mus√≠te p≈ôihl√°sit registrovan√Ωm √∫ƒçtem.');
                return;
            }
            try {
                const itemRef = doc(getBudgetItemsCollectionRef(), itemId); // Pou≈æ√≠v√°me ve≈ôejnou kolekci
                await updateDoc(itemRef, {
                    day: dayId, // Ensure day is updated/maintained
                    description: description,
                    category: category,
                    people: parseInt(people),
                    currency: currency,
                    amount: parseFloat(amount),
                    amountCZK: parseFloat(amountCZK),
                    timestamp: Date.now(),
                    ownerId: currentUserId // D≈Øle≈æit√©: Ujistƒõte se, ≈æe ownerId z≈Øst√°v√°
                });
                showCustomAlert('Polo≈æka rozpoƒçtu √∫spƒõ≈°nƒõ aktualizov√°na!');
            } catch (error) {
                console.error("Error updating budget item:", error);
                showCustomAlert(`Chyba p≈ôi aktualizaci polo≈æky: ${error.message}`);
            }
        }

        async function deleteBudgetItem(itemId) {
            if (!currentUserId || isUserAnonymous) {
                showCustomAlert('Pro smaz√°n√≠ polo≈æky rozpoƒçtu se mus√≠te p≈ôihl√°sit registrovan√Ωm √∫ƒçtem.');
                return;
            }
            showCustomConfirm('Opravdu chcete smazat tuto polo≈æku rozpoƒçtu?', async (confirmed) => {
                if (confirmed) {
                    try {
                        await deleteDoc(doc(getBudgetItemsCollectionRef(), itemId)); // Pou≈æ√≠v√°me ve≈ôejnou kolekci
                        showCustomAlert('Polo≈æka rozpoƒçtu √∫spƒõ≈°nƒõ smaz√°na!');
                    } catch (error) {
                        console.error("Error deleting budget item:", error);
                        showCustomAlert(`Chyba p≈ôi maz√°n√≠ polo≈æky: ${error.message}`);
                    }
                }
            });
        }

        // --- Render Functions ---
        function renderDiaryEntries(dayId, entries) {
            const diaryContainer = document.getElementById(`diary-entries-day-${dayId}`);
            if (!diaryContainer) return;

            diaryContainer.innerHTML = ''; // Clear existing entries

            // Filter entries by day and sort by timestamp
            const dayEntries = entries.filter(entry => entry.day === dayId).sort((a, b) => a.timestamp - b.timestamp);

            if (dayEntries.length === 0) {
                diaryContainer.innerHTML = '<p class="text-gray-500 text-center">≈Ω√°dn√© z√°znamy den√≠ku pro tento den.</p>';
            } else {
                dayEntries.forEach(entry => {
                    const entryDiv = document.createElement('div');
                    entryDiv.className = 'bg-blue-50 p-3 rounded-lg shadow-sm mb-3 relative';

                    // Determine if edit/delete buttons should be visible
                    const showEditDeleteButtons = !isUserAnonymous && entry.ownerId === currentUserId;
                    const editDeleteClass = showEditDeleteButtons ? '' : 'hidden';

                    let photosHtml = '';
                    if (entry.photos && entry.photos.length > 0) {
                        photosHtml = '<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 mt-2">';
                        entry.photos.forEach(photo => {
                            photosHtml += `<img src="${photo.url}" alt="${entry.photoCaption || 'Diary photo'}" class="w-full h-32 object-cover rounded-md cursor-pointer diary-photo" data-caption="${entry.photoCaption || ''}">`;
                        });
                        photosHtml += '</div>';
                    }

                    entryDiv.innerHTML = `
                        <p class="text-gray-800 mb-2">${entry.text}</p>
                        ${photosHtml}
                        ${entry.photoCaption ? `<p class="text-sm text-gray-600 italic mt-1">${entry.photoCaption}</p>` : ''}
                        <p class="text-xs text-gray-400 mt-2">Zaznamen√°no: ${new Date(entry.timestamp).toLocaleString()}</p>
                        <div class="absolute top-2 right-2 flex space-x-1 ${editDeleteClass}">
                            <button class="text-blue-600 hover:text-blue-800 edit-diary-btn" data-entry-id="${entry.id}" data-day-id="${entry.day}" data-text="${entry.text}" data-photos='${JSON.stringify(entry.photos || [])}' data-photocaption="${entry.photoCaption || ''}" data-owner-id="${entry.ownerId}">Upravit</button>
                            <button class="text-red-600 hover:text-red-800 delete-diary-btn" data-entry-id="${entry.id}" data-photos='${JSON.stringify(entry.photos || [])}' data-owner-id="${entry.ownerId}">Smazat</button>
                        </div>
                    `;
                    diaryContainer.appendChild(entryDiv);
                });
            }
            setupDiaryEntryListeners(); // Re-attach listeners to newly rendered elements
            setupLightboxListeners();
        }

        function renderBudgetItemsForDay(dayId, items) {
            const budgetListContainer = document.getElementById(`budget-items-list-day-${dayId}`);
            if (!budgetListContainer) return;

            budgetListContainer.innerHTML = ''; // Clear existing items

            const dayItems = items.filter(item => item.day === dayId).sort((a, b) => a.timestamp - b.timestamp);

            if (dayItems.length === 0) {
                budgetListContainer.innerHTML = '<p class="text-gray-500 text-center">≈Ω√°dn√© polo≈æky rozpoƒçtu pro tento den.</p>';
            } else {
                const table = document.createElement('table');
                table.className = 'min-w-full bg-white border border-gray-200 rounded-lg shadow-md';
                table.innerHTML = `
                    <thead>
                        <tr class="bg-gray-100 border-b">
                            <th class="py-2 px-4 text-left text-sm font-semibold text-gray-600">Popis</th>
                            <th class="py-2 px-4 text-left text-sm font-semibold text-gray-600">Kategorie</th>
                            <th class="py-2 px-4 text-left text-sm font-semibold text-gray-600">Osob</th>
                            <th class="py-2 px-4 text-left text-sm font-semibold text-gray-600">ƒå√°stka</th>
                            <th class="py-2 px-4 text-left text-sm font-semibold text-gray-600">CZK (na osobu)</th>
                            <th class="py-2 px-4 text-left text-sm font-semibold text-gray-600">Akce</th>
                        </tr>
                    </thead>
                    <tbody id="budget-table-body-day-${dayId}">
                    </tbody>
                `;
                budgetListContainer.appendChild(table);
                const tbody = document.getElementById(`budget-table-body-day-${dayId}`);

                dayItems.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';
                    const amountPerPersonCZK = item.amountCZK / item.people;

                    // Determine if edit/delete buttons should be visible
                    const showEditDeleteButtons = !isUserAnonymous && item.ownerId === currentUserId;
                    const editDeleteClass = showEditDeleteButtons ? '' : 'hidden';

                    row.innerHTML = `
                        <td class="py-2 px-4 text-sm text-gray-700">${item.description}</td>
                        <td class="py-2 px-4 text-sm text-gray-700">${item.category}</td>
                        <td class="py-2 px-4 text-sm text-gray-700">${item.people}</td>
                        <td class="py-2 px-4 text-sm text-gray-700">${item.amount.toFixed(2)} ${item.currency}</td>
                        <td class="py-2 px-4 text-sm text-gray-700">${amountPerPersonCZK.toFixed(2)} CZK</td>
                        <td class="py-2 px-4 text-sm text-gray-700 flex space-x-2 ${editDeleteClass}">
                            <button class="text-blue-600 hover:text-blue-800 edit-budget-btn" data-item-id="${item.id}" data-day-id="${dayId}" data-owner-id="${item.ownerId}">Upravit</button>
                            <button class="text-red-600 hover:text-red-800 delete-budget-btn" data-item-id="${item.id}" data-day-id="${dayId}" data-owner-id="${item.ownerId}">Smazat</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
            setupBudgetItemListenersForDay(dayId); // Setup listeners for this specific day's items
        }

        let budgetDonutChartInstance = null;
        let costBarChartInstance = null;

        function updateBudgetCharts(actualBudgetItems) {
            const actualSpentPerCategory = {};
            plannedBudgetLabels.forEach(label => actualSpentPerCategory[label] = 0);

            actualBudgetItems.forEach(item => {
                if (plannedBudgetLabels.includes(item.category)) {
                    actualSpentPerCategory[item.category] += (item.amountCZK / item.people);
                } else {
                    // Handle categories not in plannedBudgetLabels if necessary, or add them dynamically
                    actualSpentPerCategory['R≈Øzn√©'] += (item.amountCZK / item.people); // Fallback to miscellaneous
                }
            });

            const actualSpentChartData = Object.values(actualSpentPerCategory);
            const totalActualSpent = actualSpentChartData.reduce((sum, val) => sum + val, 0);

            document.getElementById('estimated-cost-display').textContent = `${Math.round(totalActualSpent)} Kƒç`;
            const budgetStatusText = document.getElementById('budget-status-text');
            if (budgetStatusText) {
                budgetStatusText.textContent = totalActualSpent <= estimatedCostPerPerson ? '√öspƒõ≈°nƒõ v r√°mci limitu 45 000 Kƒç!' : `P≈ôekroƒçeno o ${Math.round(totalActualSpent - estimatedCostPerPerson)} Kƒç!`;
                budgetStatusText.classList.toggle('text-green-600', totalActualSpent <= estimatedCostPerPerson);
                budgetStatusText.classList.toggle('text-red-600', totalActualSpent > estimatedCostPerPerson);
            }

            // Update Donut Chart
            const budgetDonutCtx = document.getElementById('budgetDonutChart')?.getContext('2d');
            if (budgetDonutCtx) {
                if (budgetDonutChartInstance) {
                    budgetDonutChartInstance.destroy();
                }
                budgetDonutChartInstance = new Chart(budgetDonutCtx, {
                    type: 'doughnut',
                    data: {
                        labels: plannedBudgetLabels,
                        datasets: [{
                            label: 'Skuteƒçn√© ƒçerp√°n√≠ (Kƒç)',
                            data: actualSpentChartData,
                            backgroundColor: Object.values(palette),
                            borderColor: '#ffffff',
                            borderWidth: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' },
                            title: { display: true, text: 'Skuteƒçn√© ƒçerp√°n√≠ rozpoƒçtu (na osobu)', font: { size: 16 } },
                            tooltip: { callbacks: { title: tooltipTitleCallback } }
                        }
                    }
                });
            }

            // Update Bar Chart (Planned vs Actual)
            const costBarCtx = document.getElementById('costBarChart')?.getContext('2d');
            if (costBarCtx) {
                if (costBarChartInstance) {
                    costBarChartInstance.destroy();
                }

                // Ensure labels are in the same order for both planned and actual
                const orderedActualSpent = plannedBudgetLabels.map(label => actualSpentPerCategory[label]);

                costBarChartInstance = new Chart(costBarCtx, {
                    type: 'bar',
                    data: {
                        labels: plannedBudgetLabels.map(wrapLabel),
                        datasets: [
                            {
                                label: 'Pl√°novan√© n√°klady (Kƒç)',
                                data: plannedBudgetChartData,
                                backgroundColor: Object.values(palette).map(color => `${color}80`), // Lighter shade for planned
                                borderColor: Object.values(palette),
                                borderWidth: 1
                            },
                            {
                                label: 'Skuteƒçn√© n√°klady (Kƒç)',
                                data: orderedActualSpent,
                                backgroundColor: Object.values(palette).map(color => color), // Solid color for actual
                                borderColor: Object.values(palette),
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' },
                            title: { display: true, text: 'Pl√°novan√© vs. Skuteƒçn√© n√°klady (na osobu)', font: { size: 16 } },
                            tooltip: { callbacks: { title: tooltipTitleCallback } }
                        },
                        scales: {
                            x: { beginAtZero: true, stacked: false, grid: { display: false } },
                            y: { stacked: false, grid: { display: false } }
                        }
                    }
                });
            }
        }

        // --- Event Listeners Setup ---
        function setupDiaryEntryListeners() {
            document.querySelectorAll('.edit-diary-btn').forEach(button => {
                button.onclick = (e) => {
                    // Check if the user is the owner of the item AND not anonymous
                    if (isUserAnonymous || e.target.dataset.ownerId !== currentUserId) {
                        showCustomAlert('Pro √∫pravu z√°znamu mus√≠te b√Ωt p≈ôihl√°≈°en(a) registrovan√Ωm √∫ƒçtem a b√Ωt vlastn√≠kem z√°znamu.');
                        return;
                    }
                    const dayId = parseInt(e.target.dataset.dayId);
                    const entryId = e.target.dataset.entryId;
                    const text = e.target.dataset.text;
                    const photos = JSON.parse(e.target.dataset.photos || '[]'); // Parse photos array
                    const photoCaption = e.target.dataset.photocaption;

                    const diaryForm = document.getElementById(`diary-form-day-${dayId}`);
                    if (diaryForm) {
                        diaryForm.querySelector('textarea[name="diary-text"]').value = text;
                        diaryForm.querySelector('input[name="photo-caption"]').value = photoCaption;
                        // No specific display for existing photos in the edit form, new ones will be appended.

                        diaryForm.querySelector('button[type="submit"]').textContent = 'Ulo≈æit √∫pravy';
                        const cancelBtn = diaryForm.querySelector('.cancel-diary-edit-btn');
                        if (cancelBtn) cancelBtn.classList.remove('hidden');

                        currentDiaryEntryToEdit = { id: entryId, day: dayId, photos: photos };
                    }
                };
            });

            document.querySelectorAll('.delete-diary-btn').forEach(button => {
                button.onclick = (e) => {
                    // Check if the user is the owner of the item AND not anonymous
                    if (isUserAnonymous || e.target.dataset.ownerId !== currentUserId) {
                        showCustomAlert('Pro smaz√°n√≠ z√°znamu mus√≠te b√Ωt p≈ôihl√°≈°en(a) registrovan√Ωm √∫ƒçtem a b√Ωt vlastn√≠kem z√°znamu.');
                        return;
                    }
                    const entryId = e.target.dataset.entryId;
                    const photos = JSON.parse(e.target.dataset.photos || '[]'); // Get photos array
                    deleteDiaryEntry(entryId, photos);
                };
            });

            document.addEventListener('submit', async (e) => {
            const form = e.target && e.target.closest('.add-diary-form');
            if (!form) return;
            e.preventDefault();
            try {
                const dayId = form.getAttribute('data-day-id');
                const textEl = form.querySelector('textarea[name="diary-text"]') || form.querySelector('textarea');
                const fileInput = form.querySelector('input[type="file"]');
                const text = (textEl && textEl.value ? textEl.value : '').trim();
                const files = (fileInput && fileInput.files) ? Array.from(fileInput.files) : [];

                if (form.classList && form.classList.contains('editing')) {
                    const entryId = form.getAttribute('data-entry-id');
                    if (typeof updateDiaryEntry === 'function') {
                        await updateDiaryEntry(entryId, dayId, text, files);
                    } else if (typeof addDiaryEntry === 'function') {
                        await addDiaryEntry(dayId, text, files, '');
                    }
                    form.classList.remove('editing');
                    const submitBtn = form.querySelector('button[type="submit"]');
                    if (submitBtn) submitBtn.textContent = 'P≈ôidat z√°znam';
                    const cancelBtn = form.querySelector('.cancel-diary-edit-btn');
                    if (cancelBtn) cancelBtn.classList.add('hidden');
                } else {
                    if (typeof addDiaryEntry === 'function') {
                        await addDiaryEntry(dayId, text, files, '');
                    }
                }
                form.reset();
            } catch (err) {
                console.error('add-diary-form submit error:', err);
                if (typeof showCustomAlert === 'function') showCustomAlert('Nepoda≈ôilo se ulo≈æit z√°znam den√≠ku.');
            }
        });
document.querySelectorAll('.cancel-diary-edit-btn').forEach(button => {
                button.onclick = (e) => {
                    const form = e.target.closest('form');
                    form.reset();
                    form.querySelector('button[type="submit"]').textContent = 'P≈ôidat z√°znam';
                    e.target.classList.add('hidden');
                    currentDiaryEntryToEdit = null;
                };
            });
        }

        function setupBudgetItemListenersForDay(dayId) {
            const form = document.querySelector(`.add-budget-form[data-day-id="${dayId}"]`);
            if (!form) return;

            const descriptionInput = form.querySelector('input[name="description"]');
            const categorySelect = form.querySelector('select[name="category"]');
            const peopleSelect = form.querySelector('select[name="people"]');
            const currencySelect = form.querySelector('select[name="currency"]');
            const amountInput = form.querySelector('input[name="amount"]');
            const amountCzkInput = form.querySelector('input[name="amountCZK"]');
            const saveBtn = form.querySelector('.save-budget-item-btn');
            const cancelBtn = form.querySelector('.cancel-edit-budget-btn');

            const updateCzkAmount = () => {
                const amount = parseFloat(amountInput.value);
                const currency = currencySelect.value;
                if (!isNaN(amount) && currency) {
                    amountCzkInput.value = convertCurrency(amount, currency).toFixed(2);
                } else {
                    amountCzkInput.value = '';
                }
            };

            amountInput.oninput = updateCzkAmount;
            currencySelect.onchange = updateCzkAmount;

            form.onsubmit = async (e) => {
                e.preventDefault();
                if (isUserAnonymous) {
                    showCustomAlert('Pro p≈ôid√°n√≠/√∫pravu polo≈æky rozpoƒçtu se mus√≠te p≈ôihl√°sit registrovan√Ωm √∫ƒçtem.');
                    return;
                }

                const description = descriptionInput.value.trim();
                const category = categorySelect.value;
                const people = peopleSelect.value;
                const currency = currencySelect.value;
                const amount = amountInput.value;
                const amountCZK = amountCzkInput.value;

                if (!description || !category || !people || !currency || !amount || isNaN(parseFloat(amount))) {
                    showCustomAlert('Pros√≠m, vypl≈àte v≈°echna pole a zadejte platnou ƒç√°stku.');
                    return;
                }

                if (currentBudgetItemToEdit && currentBudgetItemToEdit.day === dayId) {
                    await updateBudgetItem(currentBudgetItemToEdit.id, dayId, description, category, people, currency, amount, amountCZK);
                    currentBudgetItemToEdit = null;
                    saveBtn.textContent = 'Ulo≈æit polo≈æku';
                    cancelBtn.classList.add('hidden');
                } else {
                    await addBudgetItem(dayId, description, category, people, currency, amount, amountCZK);
                }
                // Clear form
                form.reset();
                amountCzkInput.value = ''; // Ensure CZK field is cleared
            };

            cancelBtn.onclick = () => {
                form.reset();
                amountCzkInput.value = '';
                saveBtn.textContent = 'Ulo≈æit polo≈æku';
                cancelBtn.classList.add('hidden');
                currentBudgetItemToEdit = null;
            };

            // Setup edit/delete buttons for this specific day's items
            document.querySelectorAll(`#budget-items-list-day-${dayId} .edit-budget-btn`).forEach(button => {
                button.onclick = (e) => {
                    // Check if the user is the owner of the item AND not anonymous
                    if (isUserAnonymous || e.target.dataset.ownerId !== currentUserId) {
                        showCustomAlert('Pro √∫pravu polo≈æky mus√≠te b√Ωt p≈ôihl√°≈°en(a) registrovan√Ωm √∫ƒçtem a b√Ωt vlastn√≠kem polo≈æky.');
                        return;
                    }
                    const itemId = e.target.dataset.itemId;
                    const item = budgetItems.find(i => i.id === itemId);
                    if (item) {
                        descriptionInput.value = item.description;
                        categorySelect.value = item.category;
                        peopleSelect.value = item.people;
                        currencySelect.value = item.currency;
                        amountInput.value = item.amount;
                        amountCzkInput.value = item.amountCZK.toFixed(2);

                        saveBtn.textContent = 'Ulo≈æit √∫pravy';
                        cancelBtn.classList.remove('hidden');
                        currentBudgetItemToEdit = item;
                    }
                };
            });

            document.querySelectorAll(`#budget-items-list-day-${dayId} .delete-budget-btn`).forEach(button => {
                button.onclick = (e) => {
                    // Check if the user is the owner of the item AND not anonymous
                    if (isUserAnonymous || e.target.dataset.ownerId !== currentUserId) {
                        showCustomAlert('Pro smaz√°n√≠ polo≈æky mus√≠te b√Ωt p≈ôihl√°≈°en(a) registrovan√Ωm √∫ƒçtem a b√Ωt vlastn√≠kem polo≈æky.');
                        return;
                    }
                    const itemId = e.target.dataset.itemId;
                    deleteBudgetItem(itemId);
                };
            });
        }


        function setupLightboxListeners() {
            document.querySelectorAll('.diary-photo').forEach(img => {
                img.addEventListener('click', (e) => {
                    openLightbox(e.target.src, e.target.dataset.caption);
                });
            });
        }

        function openLightbox(src, caption) {
            const lightbox = document.getElementById('lightbox');
            const lightboxImg = document.getElementById('lightbox-img');
            const lightboxCaption = document.getElementById('lightbox-caption');
            lightboxImg.src = src;
            lightboxCaption.textContent = caption;
            lightbox.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Prevent scrolling
        }

        // --- Main Initialization ---
        let allDiaryEntries = [];
        let budgetItems = [];

        function setupFirestoreListeners() {
            if (!db || !currentUserId) {
                console.warn("DEBUG: Firestore not initialized or userId not available for listeners. Skipping Firestore listeners setup.");
                return;
            }
            console.log(`DEBUG: Setting up Firestore listeners for user ID: ${currentUserId}`);

            // Diary Entries Listener - now listening to the public collection
            const diaryQuery = query(getDiaryEntriesCollectionRef());
            onSnapshot(diaryQuery, (snapshot) => {
                allDiaryEntries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log(`DEBUG: Naƒçteno ${allDiaryEntries.length} z√°znam≈Ø den√≠ku.`);
                itineraryData.forEach(item => {
                    renderDiaryEntries(item.day, allDiaryEntries);
                });
            }, (error) => {
                console.error("Error listening to diary entries:", error);
                showCustomAlert(`Chyba p≈ôi naƒç√≠t√°n√≠ den√≠ku: ${error.message}`);
            });

            // Budget Items Listener - now listening to the public collection
            const budgetQuery = query(getBudgetItemsCollectionRef());
            onSnapshot(budgetQuery, (snapshot) => {
                budgetItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log(`DEBUG: Naƒçteno ${budgetItems.length} polo≈æek rozpoƒçtu.`);
                // Render budget items for each day
                itineraryData.forEach(item => {
                    renderBudgetItemsForDay(item.day, budgetItems);
                });
                // Update overall budget charts
                updateBudgetCharts(budgetItems);
            }, (error) => {
                console.error("Error listening to budget items:", error);
                showCustomAlert(`Chyba p≈ôi naƒç√≠t√°n√≠ rozpoƒçtu: ${error.message}`);
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            console.log("DEBUG: DOMContentLoaded event fired. Initializing application.");

            await initializeFirebase(); // Initialize Firebase and handle initial auth state

            const timelineContainer = document.getElementById('timeline-container');
            timelineContainer.innerHTML = '';

            const fragment = document.createDocumentFragment();

            itineraryData.forEach(item => {
                const timelineItemDiv = document.createElement('div');
                timelineItemDiv.className = 'timeline-item';

                let linksHtml = Object.keys(item.links).length > 0 ? '<div class="mt-4"><h5 class="font-bold text-gray-800">U≈æiteƒçn√© odkazy:</h5><ul class="list-disc list-inside">' : '';
                for (const [text, url] of Object.entries(item.links)) {
                    linksHtml += `<li><a href="${url}" target="_blank" class="text-blue-600 hover:underline">${text}</a></li>`;
                }
                linksHtml += Object.keys(item.links).length > 0 ? '</ul></div>' : '';

                const transportHtml = item.transport ? `<div class="mt-4"><h5 class="font-bold text-gray-800">Doprava:</h5><p class="text-gray-600">${item.transport}</p></div>` : '';

                const mapPlaceholderHtml = item.mapData ? `<div class="map-placeholder" data-day-id="${item.day}"></div>` : '';

                const hotelInfoHtml = item.hotel ? `<div class="mt-4"><h5 class="font-bold text-gray-800">Ubytov√°n√≠:</h5><p class="text-gray-600">${item.hotel}</p></div>` : '';

                timelineItemDiv.innerHTML = `
                    <div class="timeline-dot"></div>
                    <div class="cursor-pointer timeline-header">
                        <h4 class="text-lg md:text-xl font-bold" style="color: #004E89;">${item.day}. Den: ${item.title}</h4>
                        <p class="text-sm font-semibold text-gray-500 mb-2">${item.date}</p>
                    </div>
                    <div class="details-content pl-4 border-l-2 border-gray-200">
                         <div class="prose max-w-none text-gray-700">
                            <p>${item.details}</p>
                            ${transportHtml}
                            ${linksHtml}
                            ${hotelInfoHtml}
                            ${mapPlaceholderHtml}

                            <div class="mt-6 border-t pt-4">
                                <h5 class="text-xl font-bold mb-3" style="color: #004E89;">Cestovn√≠ den√≠k pro tento den</h5>
                                <div id="diary-entries-day-${item.day}" class="mb-4">
                                    <p class="text-gray-500 text-center">Naƒç√≠t√°n√≠ z√°znam≈Ø den√≠ku...</p>
                                </div>
                                <div class="add-diary-section editable-content ${isUserAnonymous ? 'hidden' : ''}">
                                    <h6 class="text-lg font-bold mb-2">P≈ôidat/Upravit z√°znam</h6>
                                    <form class="add-diary-form" data-day-id="${item.day}" id="diary-form-day-${item.day}">
                                        <textarea name="diary-text" class="w-full p-2 border rounded-md mb-2" rows="3" placeholder="Napi≈°te sv≈Øj z√°≈æitek..."></textarea>
                                        <input type="file" name="diary-photo" accept="image/*" class="w-full p-2 border rounded-md mb-2"><div class="flex space-x-2">
                                            <button type="submit" class="bg-indigo-500 hover:bg-indigo-600 text-white py-2 px-4 rounded-lg">P≈ôidat z√°znam</button>
                                            <button type="button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded-lg cancel-diary-edit-btn hidden">Zru≈°it</button>
                                        </div>
                                <div class="mt-6 border-t pt-4">
                                    <h5 class="text-xl font-bold mb-3" style="color: #004E89;">Soukrom√° pozn√°mka k tomuto dni</h5>
                                    <div class="space-y-2">
                                        <textarea class="w-full p-2 border rounded-md" rows="3" placeholder="Soukrom√° pozn√°mka (viditeln√° jen pro p≈ôihl√°≈°en√© e‚Äëmailem)" id="private-note-${item.day}"></textarea>
                                        <div class="flex items-center justify-between">
                                            <small id="private-note-hint-${item.day}" class="text-gray-500">Pro √∫pravy se p≈ôihlaste e‚Äëmailem a heslem.</small>
                                            <button class="save-private-note-btn bg-indigo-600 text-white py-2 px-4 rounded-lg" data-day-id="${item.day}">Ulo≈æit pozn√°mku</button>
                                        </div>
                                    </div>
                                </div>

                                    </form>
                                </div>
                            </div>

                            <!-- NEW BUDGET SECTION FOR EACH DAY -->
                            <div class="mt-6 border-t pt-4">
                                <h5 class="text-xl font-bold mb-3" style="color: #004E89;">Rozpoƒçet pro tento den</h5>
                                <div class="mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200 budget-input-section editable-content ${isUserAnonymous ? 'hidden' : ''}">
                                    <h3 class="text-lg font-bold mb-4" style="color: #002D62;">P≈ôidat/Upravit polo≈æku rozpoƒçtu</h3>
                                    <form class="add-budget-form" data-day-id="${item.day}">
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label for="budget-description-${item.day}" class="block text-sm font-medium text-gray-700">Popis</label>
                                                <input type="text" id="budget-description-${item.day}" name="description" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2">
                                            </div>
                                            <div>
                                                <label for="budget-category-${item.day}" class="block text-sm font-medium text-gray-700">Kategorie</label>
                                                <select id="budget-category-${item.day}" name="category" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2">
                                                    <option value="">Vyberte kategorii</option>
                                                    <option value="Ubytov√°n√≠">Ubytov√°n√≠</option>
                                                    <option value="Doprava (Mezimƒõsto)">Doprava (Mezimƒõsto)</option>
                                                    <option value="Doprava (M√≠stn√≠)">Doprava (M√≠stn√≠)</option>
                                                    <option value="Aktivity">Aktivity</option>
                                                    <option value="J√≠dlo">J√≠dlo</option>
                                                    <option value="R≈Øzn√©">R≈Øzn√©</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label for="budget-people-${item.day}" class="block text-sm font-medium text-gray-700">Poƒçet osob</label>
                                                <select id="budget-people-${item.day}" name="people" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2">
                                                    <option value="1">1</option>
                                                    <option value="2">2</option>
                                                    <option value="3">3</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label for="budget-currency-${item.day}" class="block text-sm font-medium text-gray-700">Mƒõna</label>
                                                <select id="budget-currency-${item.day}" name="currency" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2">
                                                    <option value="CZK">CZK</option>
                                                    <option value="EUR">EUR</option>
                                                    <option value="USD">USD</option>
                                                    <option value="AED">AED</option>
                                                    <option value="KRW">KRW</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label for="budget-amount-${item.day}" class="block text-sm font-medium text-gray-700">ƒå√°stka</label>
                                                <input type="number" id="budget-amount-${item.day}" name="amount" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2">
                                            </div>
                                            <div>
                                                <label for="budget-amount-czk-${item.day}" class="block text-sm font-medium text-gray-700">ƒå√°stka v CZK</label>
                                                <input type="text" id="budget-amount-czk-${item.day}" name="amountCZK" class="mt-1 block w-full rounded-md border-gray-300 bg-gray-100 shadow-sm p-2" readonly>
                                            </div>
                                        </div>
                                        <div class="mt-4 flex justify-end space-x-2">
                                            <button type="submit" class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg save-budget-item-btn">Ulo≈æit polo≈æku</button>
                                            <button type="button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded-lg cancel-edit-budget-btn hidden">Zru≈°it</button>
                                        </div>
                                    </form>
                                </div>
                                <div id="budget-items-list-day-${item.day}" class="space-y-4">
                                    <p class="text-gray-500 text-center">Naƒç√≠t√°n√≠ polo≈æek rozpoƒçtu...</p>
                                </div>
                            </div>
                         </div>
                    </div>
                `;
                fragment.appendChild(timelineItemDiv);
            });
            timelineContainer.appendChild(fragment);

            // Initial rendering of diary entries and budget items (will be updated by onSnapshot)
            itineraryData.forEach(item => {
                renderDiaryEntries(item.day, []); // Render empty initially
                renderBudgetItemsForDay(item.day, []); // Render empty initially
            });

            document.querySelectorAll('.timeline-header').forEach(header => {
                header.addEventListener('click', () => {
                    const content = header.nextElementSibling;
                    const dayIndex = parseInt(header.parentElement.querySelector('.timeline-dot').parentElement.querySelector('h4').textContent.split('.')[0]) - 1;
                    const currentDayData = itineraryData[dayIndex];

                    if (content.style.maxHeight) {
                        content.style.maxHeight = null;
                        header.parentElement.querySelector('.timeline-dot').style.backgroundColor = '#00A5E3';
                    } else {
                        document.querySelectorAll('.details-content').forEach(el => {
                            if (el !== content) {
                                el.style.maxHeight = null;
                            }
                        });
                        document.querySelectorAll('.timeline-dot').forEach(dot => dot.style.backgroundColor = '#00A5E3');

                        content.style.maxHeight = content.scrollHeight + "px";
                        header.parentElement.querySelector('.timeline-dot').style.backgroundColor = '#FF5768';

                        if (currentDayData.mapData && typeof google !== 'undefined' && typeof google.maps !== 'undefined') {
                            const mapPlaceholder = content.querySelector(`.map-placeholder[data-day-id="${currentDayData.day}"]`);

                            if (mapPlaceholder) {
                                let mapInstance = maps[`day-${currentDayData.day}`];
                                if (!mapInstance) {
                                    const mapDiv = document.createElement('div');
                                    mapDiv.className = 'map-container mt-4 rounded-lg overflow-hidden shadow-md';
                                    mapDiv.id = `map-day-${currentDayData.day}`;
                                    mapPlaceholder.appendChild(mapDiv);

                                    mapInstance = new google.maps.Map(mapDiv, {
                                        center: currentDayData.mapData.center,
                                        zoom: currentDayData.mapData.zoom,
                                        mapTypeControl: false,
                                        streetViewControl: false,
                                        fullscreenControl: false
                                    });

                                    const infoWindow = new google.maps.InfoWindow();
                                    currentDayData.mapData.markers.forEach(markerData => {
                                        const marker = new google.maps.Marker({
                                            position: { lat: markerData.lat, lng: markerData.lng },
                                            map: mapInstance,
                                            title: markerData.title
                                        });
                                        marker.addListener("click", () => {
                                            infoWindow.setContent(`<strong>${markerData.title}</strong><br>${markerData.description}`);
                                            infoWindow.open(mapInstance, marker);
                                        });
                                    });
                                    maps[`day-${currentDayData.day}`] = mapInstance;
                                }

                                google.maps.event.trigger(mapInstance, 'resize');
                                mapInstance.setCenter(currentDayData.mapData.center);

                            } else {
                                console.error("DEBUG: Kontejner mapy nenalezen pro ID:", `map-day-${currentDayData.day}`, "Placeholder not found.");
                            }
                        } else {
                            console.error("DEBUG: Google Maps API nen√≠ naƒçteno nebo data mapy nenalezena.");
                        }
                        // Re-adjust max-height after content potentially changes (e.g., diary entries load)
                        content.style.maxHeight = content.scrollHeight + "px";
                    }
                });
            });

            const tabs = document.querySelectorAll('.tab-button');
            const tabPanes = document.querySelectorAll('.tab-pane');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    tabs.forEach(item => item.classList.remove('active'));
                    tab.classList.add('active');
                    tabPanes.forEach(pane => {
                        pane.id === `${tabId}-content` ? pane.classList.remove('hidden') : pane.classList.add('hidden');
                    });
                });
            });

            // Initial budget chart rendering (will be updated by onSnapshot)
            updateBudgetCharts([]);

            const lightbox = document.getElementById('lightbox');
            const closeLightboxBtn = document.getElementById('close-lightbox');

            if (closeLightboxBtn && lightbox) {
                closeLightboxBtn.addEventListener('click', () => {
                    lightbox.classList.add('hidden');
                    document.body.style.overflow = '';
                });
                lightbox.addEventListener('click', (e) => {
                    if (e.target === lightbox) {
                        lightbox.classList.add('hidden');
                        document.body.style.overflow = '';
                    }
                });
            } else {
                console.error("DEBUG: Lightbox elements not found. Lightbox functionality may be impaired.");
            }

            // --- Auth UI Event Listeners ---
            document.getElementById('login-form-content').addEventListener('submit', handleLogin);
            // Removed the event listener for the register button
            document.getElementById('anonymous-login-btn-modal').addEventListener('click', async () => {
                try {
                    await signInAnonymously(auth);
                    document.getElementById('login-modal').classList.add('hidden');
                } catch (error) {
                    console.error("Anonymous login error:", error);
                    document.getElementById('login-error').textContent = `Chyba anonymn√≠ho p≈ôihl√°≈°en√≠: ${error.message}`;
                }
            });
            document.getElementById('show-login-form-btn').addEventListener('click', showLoginForm);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
        });
    
        // --- Diary photos subcollection helpers ---
        function startDiaryPhotosListener(entryId) {
            if (!currentUserId) return;
            const photosContainer = document.getElementById(`photos-${entryId}`);
            if (!photosContainer) return;

            const photosRef = collection(db, `artifacts/${appId}/public/data/diary/${entryId}/photos`);
            onSnapshot(photosRef, (snap) => {
                const photos = snap.docs.map(d => ({ id: d.id, ...d.data() }))
                                        .sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0));
                if (photos.length === 0) {
                    photosContainer.innerHTML = '<p class="text-gray-500">K tomuto z√°znamu zat√≠m nejsou fotografie.</p>';
                } else {
                    photosContainer.innerHTML = '<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 mt-2">' +
                        photos.map(p => `
                            <figure class="bg-white rounded shadow-sm p-2">
                                <img src="${p.url}" alt="${escapeHtml(p.caption || '')}" class="w-full h-32 object-cover rounded cursor-pointer diary-photo">
                                ${p.caption ? `<figcaption class="text-sm text-gray-600 mt-1">${escapeHtml(p.caption)}</figcaption>` : ''}
                                ${(!isUserAnonymous && currentUserId === p.ownerId) ? `<button class="delete-photo-btn text-xs text-red-600 mt-1" data-entry-id="${entryId}" data-photo-id="${p.id}">Smazat</button>` : ''}
                            </figure>
                        `).join('') + '</div>';
                }
            });
        }

        async function addDiaryPhoto(entryId, file, caption) {
            if (!currentUserId || isUserAnonymous) {
                showCustomAlert('Pro p≈ôid√°n√≠ fotografie se p≈ôihlaste registrovan√Ωm √∫ƒçtem.');
                return;
            }
            const photoId = Date.now().toString() + '-' + (file.name || 'photo');
            const storageRef = getPhotoStorageRef(photoId);
            const metadata = { customMetadata: { ownerId: currentUserId } };
            const snapshot = await uploadBytes(storageRef, file, metadata);
            const url = await getDownloadURL(snapshot.ref);
            await addDoc(collection(db, `artifacts/${appId}/public/data/diary/${entryId}/photos`), {
                url, caption: caption || '', createdAt: Date.now(), ownerId: currentUserId
            });
        }

        async function deleteDiaryPhoto(entryId, photoId) {
            if (!currentUserId || isUserAnonymous) return;
            await deleteDoc(doc(db, `artifacts/${appId}/public/data/diary/${entryId}/photos/${photoId}`));
        }

        // Delegated handlers for add/delete photos
        document.addEventListener('submit', async (e) => {
            const form = e.target && e.target.closest('.add-photo-form');
            if (!form) return;
            e.preventDefault();
            const entryId = form.getAttribute('data-entry-id');
            const fileInput = form.querySelector('input[name="photo-file"]');
            const captionInput = form.querySelector('input[name="photo-caption"]');
            if (!fileInput || !fileInput.files || !fileInput.files[0]) return;
            try {
                await addDiaryPhoto(entryId, fileInput.files[0], (captionInput?.value || '').trim());
                form.reset();
            } catch (err) {
                console.error(err);
                showCustomAlert('Nepoda≈ôilo se nahr√°t fotografii.');
            }
        });

        document.addEventListener('click', async (e) => {
            const btn = e.target && e.target.closest('.delete-photo-btn');
            if (!btn) return;
            try {
                await deleteDiaryPhoto(btn.getAttribute('data-entry-id'), btn.getAttribute('data-photo-id'));
            } catch (err) {
                console.error(err);
                showCustomAlert('Nepoda≈ôilo se smazat fotografii.');
            }
        });

        // --- Private itinerary note (email/password users only) ---
        function isEmailPasswordUser() {
            try {
                const u = (typeof auth !== 'undefined' && auth && auth.currentUser) ? auth.currentUser
                        : (typeof firebase !== 'undefined' && firebase.auth) ? firebase.auth().currentUser
                        : null;
                return !!(u && !u.isAnonymous && Array.isArray(u.providerData) && u.providerData.some(p => p.providerId === 'password'));
            } catch (e) { return false; }
        }

        function ensurePrivateNoteUIState() {
            const emailUser = isEmailPasswordUser();
            document.querySelectorAll('.save-private-note-btn').forEach(btn => {
                btn.disabled = !emailUser;
                btn.classList.toggle('opacity-50', !emailUser);
            });
            document.querySelectorAll('[id^="private-note-hint-"]').forEach(hint => {
                hint.textContent = emailUser ? 'Pozn√°mka je soukrom√° a ulo≈æena jen pro v√°≈° √∫ƒçet.' : 'Pro √∫pravy se p≈ôihlaste e‚Äëmailem a heslem.';
            });
        }

        async function loadPrivateNote(dayId) {
            if (!currentUserId) return;
            const noteRef = doc(db, `artifacts/${appId}/users/${currentUserId}/itinerary/${dayId}/privateNotes/note`);
            try {
                const snap = await getDoc(noteRef);
                const el = document.getElementById(`private-note-${dayId}`);
                if (el && snap.exists()) el.value = snap.data().text || '';
            } catch (e) { console.warn('loadPrivateNote error', e); }
        }

        async function savePrivateNote(dayId, text) {
            if (!currentUserId || !isEmailPasswordUser()) {
                showCustomAlert('Pozn√°mku lze upravovat jen po p≈ôihl√°≈°en√≠ e‚Äëmailem a heslem.');
                return;
            }
            const noteRef = doc(db, `artifacts/${appId}/users/${currentUserId}/itinerary/${dayId}/privateNotes/note`);
            await setDoc(noteRef, { text, updatedAt: Date.now(), ownerId: currentUserId }, { merge: true });
            showCustomAlert('Soukrom√° pozn√°mka ulo≈æena.');
        }

        document.addEventListener('click', async (e) => {
            const btn = e.target && e.target.closest('.save-private-note-btn');
            if (!btn) return;
            const dayId = btn.getAttribute('data-day-id');
            const el = document.getElementById(`private-note-${dayId}`);
            if (!dayId || !el) return;
            try { await savePrivateNote(dayId, (el.value || '').trim()); }
            catch (err) { console.error(err); showCustomAlert('Nepoda≈ôilo se ulo≈æit pozn√°mku.'); }
        });

        document.addEventListener('itinerary-rendered', () => {
            document.querySelectorAll('[id^="private-note-"]').forEach(el => {
                const dayId = el.id.replace('private-note-', '');
                loadPrivateNote(dayId);
            });
            ensurePrivateNoteUIState();
        });

        try {
            if (typeof onAuthStateChanged === 'function' && typeof auth !== 'undefined') {
                onAuthStateChanged(auth, () => { try { document.dispatchEvent(new Event('auth-state-changed')); } catch(_){} });
            }
        } catch(_) {}
        document.addEventListener('auth-state-changed', ensurePrivateNoteUIState);

        </script>
    
<script>
if (typeof window.initMap !== 'function') {
  window.initMap = function(){ try { console.warn('initMap fallback called'); } catch(_){}};
}
</script>

</body>
</html>
